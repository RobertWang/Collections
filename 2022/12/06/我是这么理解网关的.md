> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s?__biz=Mzg5Mjc3MjIyMA==&mid=2247553494&idx=1&sn=9d11a7640452be32c3ae2ee2b2a335c4&chksm=c03b5bc5f74cd2d35621ca92bc33ddd4d43c76152a9598ed5105af2ff3eaadc8e93409bec2a6&scene=21#wechat_redirect)

_—_ _**2**_ _—_  

**动态路由**

**基础概念**

路由：作为网关中最核心的能力，从源码结构上看，包括 ID、请求 URI、断言集合、过滤集合等组成。

断言 + 过滤：通常在断言中定义请求的匹配规则，在过滤中定义请求的处理动作，结构上看都是名称加参数集合，并且支持快捷的方式配置。

```
public class PredicateDefinition {
 private String name;
 private Map<String, String> args = new LinkedHashMap<>();
}

public class FilterDefinition {
 private String name;
 private Map<String, String> args = new LinkedHashMap<>();
}

```

**配置路由**

以配置的方式，添加 facade 服务路由，以路径匹配的方式，如果请求路径错误则断言失败，StripPrefix 设置为 1，即在过滤中去掉第一个 / facade 参数。

```
spring:
  application:
    name: gateway
  cloud:
    gateway:
      routes:
        - id: facade
          uri: http://127.0.0.1:8082
          predicates:
            - Path=/facade/**
          filters:
            - StripPrefix=1

```

执行原理如下：

![](https://mmbiz.qpic.cn/mmbiz_jpg/vHicVZXtcAzAykLiacgrJosg1Fk1Efcq8rsoW3p9bJy4pg3eMbjKLrg0OkuicBSJ2ym7TxjpBj0CKLkoKR2IYwjjw/640?wx_fmt=jpeg)

这里是以配置文件的方式，设置 facade 服务的路由策略，其中指定了路径方式，在 Gateway 文档中提供了多种路由样例，比如：Header、Cookie、Method、Query、Host 等断言方式。

**编码方式**

基于编码的方式管理路由策略，在 Gateway 文档同样提供了多种参考样例，如果路由服务少并且固定，配置的方式可以解决，如果路由服务很多，并且需要动态添加，那基于库表方式更适合。

```
@Configuration
public class GateConfig {
    @Bean
    public RouteLocator customRouteLocator(RouteLocatorBuilder builder) {
        return builder.routes()
                .route("facade",r -> r.path("/facade/**").filters(f -> f.stripPrefix(1))
                .uri("http://127.0.0.1:8082")).build();
    }
}

```

**库表加载**

在常规的应用中，从库表中读取路由策略是比较常见的方式，定义路由工厂类并实现 RouteDefinitionRepository 接口，涉及加载、添加、删除三个核心方法，然后基于服务类从库中读取数据转换为 RouteDefinition 对象即可。

![](https://mmbiz.qpic.cn/mmbiz_jpg/vHicVZXtcAzAykLiacgrJosg1Fk1Efcq8rMBRC04161jhanicDm1eCLwSnJRbFG5VaJYnErXOoZR6M0DibTsVk7reQ/640?wx_fmt=jpeg)

```
@Component
public class DefRouteFactory implements RouteDefinitionRepository {
    @Resource
    private ConfigRouteService routeService ;
    // 加载
    @Override
    public Flux<RouteDefinition> getRouteDefinitions() {
        return Flux.fromIterable(routeService.getRouteDefinitions());
    }
    // 添加
    @Override
    public Mono<Void> save(Mono<RouteDefinition> route) {
        return route.flatMap(routeDefinition -> { routeService.saveRouter(routeDefinition);
            return Mono.empty();
        });
    }
    // 删除
    @Override
    public Mono<Void> delete(Mono<String> idMono) {
        return idMono.flatMap(routeId -> { routeService.removeRouter(routeId);
            return Mono.empty();
        });
    }
}

```

在源码仓库中采用的就是库表管理的方式，代码逻辑的更多细节可以移步 Git 参考，此处不再过多粘贴。

_—_ _**3**_ _—_  

**自定义路由策略**

自定义断言，继承 AbstractRoutePredicateFactory 类，注意命名以 RoutePredicateFactory 结尾，重写 apply 方法，即可执行特定的匹配规则。

```
@Component
public class DefCheckRoutePredicateFactory extends AbstractRoutePredicateFactory<DefCheckRoutePredicateFactory.Config> {
    public DefCheckRoutePredicateFactory() {
        super(Config.class);
    }
    @Override
    public Predicate<ServerWebExchange> apply(Config config) {
        return new GatewayPredicate() {
            @Override
            public boolean test(ServerWebExchange serverWebExchange) {
                log.info("DefCheckRoutePredicateFactory：" + config.getName());
                return StrUtil.equals("butte",config.getName());
            }
        };
    }
    @Data
    public static class Config { private String name; }
    @Override
    public List<String> shortcutFieldOrder() { return Collections.singletonList("name"); }
}

```

自定义过滤，继承 AbstractNameValueGatewayFilterFactory 类，注意命名以 GatewayFilterFactory 结尾，重写 apply 方法，即可执行特定的过滤规则。

```
@Component
public class DefHeaderGatewayFilterFactory extends AbstractNameValueGatewayFilterFactory {
    @Override
    public GatewayFilter apply(AbstractNameValueGatewayFilterFactory.NameValueConfig config) {
        return (exchange, chain) -> {
            log.info("DefHeaderGatewayFilterFactory："+ config.getName() + "-" + config.getValue());
            return chain.filter(exchange);
        };
    }
}

```

配置加载方式，此处断言与过滤即快捷的配置方式，所以在命名上要遵守 Gateway 的约定。

```
spring:
  cloud:
    gateway:
      routes:
        - id: facade
          uri: http://127.0.0.1:8082
          predicates:
            - Path=/facade/**
            - DefCheck=butte
          filters:
            - StripPrefix=1
            - DefHeader=cicada,smile

```

通常来说，在应用级的系统中都需要进行断言和过滤的策略自定义，以提供业务或者架构层面的支撑，完成更加细致的规则校验，尤其在相同服务多版本并行时，可以更好的管理路由策略，从而避免分支之间的影响。

_—_ _**4**_ _—_  

**全局过滤器**

在路由中采用的过滤是 GatewayFilter，实际 Gateway 中还提供了 GlobalFilter 全局过滤器，虽然从结构上看十分相似，但是其职责是有本质区别的。

**全局过滤器 1：打印请求 ID**

```
@Component
@Order(1)
public class DefOneGlobalFilter implements GlobalFilter {
    @Override
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        log.info("request-id:{}",exchange.getRequest().getId()) ;
        return chain.filter(exchange);
    }
}

```

**全局过滤器 2：打印请求 URI**

```
@Component
@Order(2)
public class DefTwoGlobalFilter implements GlobalFilter {
    @Override
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        log.info("request-uri:{}",exchange.getRequest().getURI()) ;
        return chain.filter(exchange);
    }
}

```

Gateway 网关作为微服务架构系统中最先接收请求的一层，可以定义许多策略来保护系统的安全，比如高并发接口的限流，第三方授权验证，遭到恶意攻击时的 IP 拦截等等，尽量将非法请求在网关中拦截掉，从而保证系统的安全与稳定。

参考：

1.  https://gitee.com/cicadasmile/butte-flyer-parent
    
2.  https://gitee.com/cicadasmile/butte-frame-parent
    

本文源自公众号知了一笑，分布式实验室已获完整授权。

推荐阅读：

*   《[微服务改造过程中那些必须重视的问题](http://mp.weixin.qq.com/s?__biz=Mzg5Mjc3MjIyMA==&mid=2247553425&idx=1&sn=139504f458e247276d8e8f23e720f4e9&chksm=c03b5b82f74cd294d82e1b2602228dd518b5a9fb55de6ed884d3bb90fdd00eaa75615c3817e8&scene=21#wechat_redirect)》
    
*   《[Netflix 历史性地引入软件工程师级别](http://mp.weixin.qq.com/s?__biz=Mzg5Mjc3MjIyMA==&mid=2247553315&idx=1&sn=bbc805770f81eb2a0971fdce98b5427d&chksm=c03b5b30f74cd22653c5a0ddb4758dd643a234b9fad4cedb50a6d8c5fb5b512ebd268a1f8e3e&scene=21#wechat_redirect)》