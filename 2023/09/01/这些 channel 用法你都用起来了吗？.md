> æœ¬æ–‡ç”± [ç®€æ‚¦ SimpRead](http://ksria.com/simpread/) è½¬ç ï¼Œ åŸæ–‡åœ°å€ [juejin.cn](https://juejin.cn/post/7272674088778858556)*   [GO é€šé“å’Œ sync åŒ…çš„åˆ†äº«](https://juejin.cn/post/6973108979777929230 "https://juejin.cn/post/6973108979777929230")
*   [GO ä¸­ channel å®ç°åŸç†](https://juejin.cn/post/6975280009082568740 "https://juejin.cn/post/6975280009082568740")

**æœ¬æ¬¡ï¼Œæˆ‘ä»¬ä¸»è¦åˆ†äº«çš„æ˜¯å…³äº nil channel é€šé“ï¼Œæœ‰ç¼“å†²é€šé“ï¼Œæ— ç¼“å†²é€šé“ çš„å¸¸ç”¨æ–¹æ³•ä»¥åŠå·§å¦™ä½¿ç”¨çš„æ–¹å¼**

**å·§ç”¨ nil çš„ channel é€šé“**
-----------------------

å¹³æ—¥é‡Œä½¿ç”¨çš„ channel é€šé“éƒ½æ˜¯ä½¿ç”¨æ— ç¼“å†²ï¼Œæˆ–è€…æœ‰ç¼“å†²çš„ channel é€šé“ï¼Œæˆ–è®¸ä½¿ç”¨ä¸º nil çš„ channel é€šé“è¿˜æ˜¯æ¯”è¾ƒå°‘ï¼Œç”šè‡³éƒ½ä¸çŸ¥é“å¦‚ä½•å»ä½¿ç”¨ nil çš„ channel é€šé“

**æˆ‘ä»¬å…ˆæ¥çœ‹è¿™ä¹ˆä¸€ä¸ªä¾‹å­**

1.  åˆ›å»ºä¸¤ä¸ª channel c1, c2 ï¼Œæ•°æ®ç±»å‹æ˜¯ struct{} ï¼Œç”¨äºå ä½
2.  åˆ†åˆ«å¼€è¾Ÿä¸¤ä¸ªå­åç¨‹ï¼Œå…¶ä¸­å­åç¨‹ 1 åœ¨ 2 ç§’ä¹‹åå†™å…¥æ•°æ®ç»™åˆ° c1ï¼Œå¦å¤–ä¸€ä¸ªå­åç¨‹ 2 åœ¨ 1 ç§’ä¹‹åå†™å…¥æ•°æ®ç»™åˆ° c2
3.  ä¸»åç¨‹å¾ªç¯ç­‰å¾…é˜»å¡è¯»å– c1 , c2 é‡Œé¢çš„æ•°æ®ï¼Œè¯»å–åå°†å¯¹åº”çš„æ ‡è¯† ok1 / ok2 ç½®ä¸º true
4.  å½“ ok1 å’Œ ok2 éƒ½ä¸º true çš„æ—¶å€™ï¼Œé€€å‡ºå¾ªç¯ï¼Œç»“æŸç¨‹åº

```
func main() {
    c1, c2 := make(chan struct{}), make(chan struct{})
    go func() {
        time.Sleep(time.Second * 2)
        c1 <- struct{}{}
        //close(c1)
    }()

    go func() {
        time.Sleep(time.Second * 1)
        c2 <- struct{}{}
       // close(c2)
    }()

    var (
        ok1 bool
        ok2 bool
    )
    for {
        select {
        case <-c1:
                ok1 = true
                fmt.Println("1")
        case <-c2:
                ok2 = true
                fmt.Println("2")
        }

        if ok1 && ok2 {
                break
        }
    }

    fmt.Println("program termination ... ")
}


```

è¿è¡Œç»“æœå¦‚ä¸‹ï¼š

```
2
1
program termination ...


```

çœ‹ä¸Šå»æ•ˆæœä¸€åˆ‡æ­£å¸¸ï¼Œè‹¥æ­¤æ—¶ï¼Œæˆ‘ä»¬å°†ä¸Šè¿°ä»£ç ä¸­çš„ `close(c1)` å’Œ `close(c2)` çš„æ³¨é‡Šå»æ‰ï¼Œæˆ‘ä»¬å†æŸ¥çœ‹ä¸€ä¸‹ç»“æœå°±å›æ˜¯è¿™æ ·çš„ï¼š

```
...
2
2
2
1
program termination ...


```

å‡ºç°è¿™æ ·çš„é—®é¢˜æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿæ˜¯å› ä¸ºæˆ‘ä»¬ **close channel é€šé“ä¹‹åï¼Œè‹¥è¿˜å¯¹è¿™ä¸ªé€šé“å†™å…¥æ•°æ®ä¼š panicï¼Œè‹¥è¿˜ä»è¿™ä¸ªé€šé“è¯»å–æ•°æ®ä¼šç«‹å³è¿”å›è¯¥é€šé“ç±»å‹çš„é›¶å€¼ï¼Œè€Œä¸ä¼šé˜»å¡ç­‰å¾…æ•°æ®**

å› æ­¤æ‰ä¼šæœ‰ä¸Šè¿°æƒ…å†µï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™ï¼Œæˆ‘å°±å¯ä»¥å¾ˆå¥½çš„ç”¨å¥½è¿™ä¸ª nil çš„ channelï¼Œå’±å°±å¯ä»¥è¿™æ ·æ¥è°ƒæ•´ä¸€ä¸‹å…³äºé€šé“ä½¿ç”¨çš„æƒ…å†µ

ä¿®æ”¹ä¸ºï¼Œ**ä»é€šé“ä¸­è¯»å–æ•°æ®æ—¶ï¼Œå…ˆåˆ¤æ–­é€šé“æ˜¯å¦å·²ç»å…³é—­ï¼Œè‹¥å…³é—­åˆ™å°†é€šé“è®¾ç½®ä¸º nilï¼Œè‹¥æœªå…³é—­ï¼Œåˆ™æ‰“å°æˆ‘ä»¬ä»é€šé“ä¸­è¯»å–çš„æ•°æ®ï¼ˆæ­¤å¤„æ¨¡æ‹Ÿç›´æ¥æ‰“å°ä¸€ä¸ªå›ºå®šçš„å€¼ï¼‰**

```
for {
    select {
    case _, ok := <-c1:
        if !ok {
            c1 = nil
        }else{
            fmt.Println("1")
        }
    
    case _, ok := <-c2:
        if !ok {
            c2 = nil
        }else{
            fmt.Println("2")
        }
    }
    
    if c1 == nil && c2 == nil {
            break
    }
}


```

è¿™ç§æ—¶å€™ï¼Œæˆ‘ä»¬å°±çŸ¥é“å¯¹äºä»é€šé“ä¸­è¯»å–æ•°æ®ï¼Œå…ˆå»åˆ¤æ–­é€šé“æ˜¯å¦å…³é—­ï¼Œè‹¥é€šé“å…³é—­äº†ï¼Œé‚£ä¹ˆæˆ‘ä»¬ç›´æ¥æ˜¾ç¤ºçš„ç»™é€šé“è®¾ç½®ä¸º nil

**è¿™é‡Œæ˜¯å¦ä¼šæœ‰è¿™ä¹ˆä¸€ä¸ªç–‘é—®ï¼Ÿå…³é—­é€šé“ï¼Œé€šé“å˜é‡ä¸åº”è¯¥å°±å˜æˆ nil äº†å—ï¼Ÿä¸ºä»€ä¹ˆæˆ‘ä»¬è¿˜è¦è‡ªå·±å»è®¾ç½®ä¸º nilï¼Ÿ**

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4c228d23410e4de0aa76e2370bb331d7~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp#?w=198&h=198&s=67905&e=png&b=cfbfb3)

å®é™…ä¸Šè¿™å°±æ˜¯æˆ‘ä»¬å¯¹äºé€šé“çš„åŸºç¡€çŸ¥è¯†ä¸æ‰å®äº†ï¼Œå…³é—­é€šé“åï¼Œé€šé“æœ¬èº«å¹¶ä¸ä¼šå˜ä¸º nilã€‚é€šé“å˜é‡ä»ç„¶æŒæœ‰é€šé“çš„åœ°å€ï¼Œåªæ˜¯é€šé“çš„çŠ¶æ€å˜ä¸ºäº†å·²å…³é—­

å·§ç”¨æ— ç¼“å†² channel é€šé“
----------------

å¯¹äºæ— ç¼“å†²çš„ channel é€šé“ï¼Œåªæœ‰åœ¨å¯¹å…¶è¿›è¡Œæ¥æ”¶æ“ä½œçš„ goroutine åç¨‹å’Œå¯¹å…¶è¿›è¡Œå‘é€æ“ä½œçš„ goroutine åç¨‹éƒ½å­˜åœ¨çš„æƒ…å†µä¸‹ï¼Œé€šä¿¡æ‰èƒ½è¿›è¡Œï¼Œå¦åˆ™å•æ–¹é¢çš„æ“ä½œä¼šè®©å¯¹åº”çš„ goroutine åç¨‹é™·å…¥é˜»å¡çŠ¶æ€ï¼Œ**å› ä¸ºè¯¥ channel é€šé“æ²¡æœ‰ç¼“å†²**

ä½¿ç”¨æ— ç¼“å†²çš„ channel é€šé“ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨åœ¨å¦‚ä¸‹å‡ ä¸ªæ–¹é¢

1.  ä¿¡å·ä¼ é€’

ä¿¡å·ä¼ é€’æˆ‘ä»¬å°±å¯ä»¥ç”¨åœ¨ä¸¤ä¸ªåç¨‹ä¸€å¯¹ä¸€çš„ä¼ é€’ä¿¡å·ä¸Šé¢ï¼Œå½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨åœ¨ä¸»åç¨‹ä¸»åŠ¨é€šçŸ¥æ‰€æœ‰å­åç¨‹å…³é—­çš„å…¨åœºæ™¯ä¸‹ï¼Œè¿™å°±æ˜¯ä¸€å¯¹å¤šçš„ä¼ é€’ä¿¡å·ï¼Œç›¸å…³çš„ demo å¯ä»¥åœ¨è¿™æœŸæ–‡ç« ä¸­æœ‰å±•ç¤º

[GO è¯­è¨€çš„å¹¶å‘æ¨¡å¼](https://juejin.cn/post/7268965126127648807 "https://juejin.cn/post/7268965126127648807")

**ä¸€å¯¹ä¸€ï¼ˆä¸€ä¸ªå‘ä¸€ä¸ªæ”¶ï¼‰**

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9efa68fe4e114aba8ea3315663b2dc7f~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp#?w=984&h=374&s=16304&e=jpg&b=ffffff)

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1d6044854c5f49ee850201468481a6aa~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp#?w=934&h=434&s=16669&e=jpg&b=ffffff)

**ä¸€å¯¹å¤šï¼ˆä¸€ä¸ªå‘å¤šä¸ªæ”¶ï¼Œæ­¤å¤„å¯ä»¥æ˜¯ åç¨‹ 1 close æ‰ é€šé“ï¼Œé‚£ä¹ˆ å¤šä¸ªåç¨‹é»˜è®¤éƒ½èƒ½å¤Ÿè¯»å–åˆ°é€šé“çš„å€¼æ˜¯é›¶å€¼ï¼Œæ­¤æ—¶å¤šä¸ªå­åç¨‹å°±å¯ä»¥æ ¹æ®é€šé“çš„å…³é—­çŠ¶æ€æ¥å¤„ç†åç»­çš„é€»è¾‘ï¼‰**

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/29de597fcd004bc09c8761869e7ad817~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp#?w=984&h=374&s=16304&e=jpg&b=ffffff)

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f361267e6e354dc6b9e2d983129255b3~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp#?w=1094&h=994&s=46906&e=jpg&b=ffffff)

2.  æ§åˆ¶åŒæ­¥

GO è¯­è¨€å€¡å¯¼æˆ‘ä»¬**ä¸è¦é€šè¿‡å…±äº«å†…å­˜æ¥é€šä¿¡ï¼Œè€Œåº”è¯¥é€šè¿‡é€šä¿¡æ¥å…±äº«å†…å­˜**ï¼Œæ­¤å¤„ channel å°±æ˜¯è¿™æ ·è®¾è®¡çš„ï¼Œå½“ç„¶å¦‚æœéœ€è¦æœ‰æ›´é«˜çš„æ€§èƒ½ï¼Œé‚£ä¹ˆæˆ‘ä»¬è¿˜æ˜¯å¯ä»¥ä½¿ç”¨æ›´åŠ ä½çº§çš„ GO è¯­è¨€åŸè¯­ sync åŒ…ä¸­çš„é”æœºåˆ¶

å¯ä»¥ç‚¹å‡»æŸ¥çœ‹å¾€æœŸæ–‡ç« ï¼š[sync é”æœºåˆ¶](https://juejin.cn/post/7272523490497986615 "https://juejin.cn/post/7272523490497986615")

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e5d38f80799449659f6e7e2aa267c84d~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp#?w=1114&h=1002&s=49803&e=jpg&b=ffffff)

å·§ç”¨æœ‰ç¼“å†² channel é€šé“
----------------

1.  **ç”¨ä½œé˜Ÿåˆ—**

ç”¨ä½œé˜Ÿåˆ—åº”è¯¥æ˜¯æ¯”è¾ƒå¥½ç†è§£çš„ï¼Œé˜Ÿåˆ—å…ˆå…¥å…ˆå‡º FIFOï¼Œç»™ channel é€šé“è®¾ç½®æ˜ç¡®çš„ç¼“å†²åŒºï¼Œä¾‹å¦‚ `ch:=make(chan int, 10)`

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/06a9bbfeec8a4e00b3bcfd6c5f610480~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp#?w=1294&h=594&s=48409&e=jpg&b=ffffff)

å¤šä¸ªåç¨‹å°±å¯ä»¥å¼‚æ­¥çš„å¹¶å‘å¤„ç†è¯¥é˜Ÿåˆ—ï¼Œç”±äºæœ‰ç¼“å†²çš„ channel é€šé“ä¸­æœ‰ä¸€å®šçš„å®¹é‡ï¼Œå› æ­¤ï¼Œå¯¹äºåç¨‹è¯»å–é€šé“ä¸­æ•°æ®æ—¶ï¼Œå­˜åœ¨é˜»å¡çš„æƒ…å†µç›¸å¯¹æ— ç¼“å†²çš„é€šé“æ¥è¯´å°±ä¼šå°‘å¾ˆå¤šï¼Œ**ç›¸åº”çš„åœ¨ä¸€å®šç¨‹åº¦ä¸Šå°±æå‡äº†æ€§èƒ½**

å¯¹äºæœ‰ç¼“å†²çš„ channel é€šé“ï¼Œchannel é€šé“æ»¡çš„æ—¶å€™ï¼Œå†™å…¥æ•°æ®ä¼šé˜»å¡ï¼Œè¯»å–æ•°æ®æ­£å¸¸å¤„ç†ï¼Œ channel é€šé“ç©ºçš„æ—¶å€™ï¼Œå†™å…¥æ•°æ®æ­£å¸¸ï¼Œè¯»å–æ•°æ®ä¼šé˜»å¡

2.  **ç”¨ä½œä¿¡å·é‡**

æœ‰ç¼“å†²çš„ channel é€šé“è¿˜å¯ä»¥ç”¨æ¥è®¡æ•°ï¼Œä¾‹å¦‚æˆ‘ä»¬æœ‰ 15 ä¸ª jobï¼Œå¯æ˜¯ç›®å‰åªæœ‰ 3 ä¸ª workerï¼Œé‚£ä¹ˆåŒä¸€æ—¶é—´ï¼Œåªä¼šæœ‰ 3 ä¸ª worker æ¥å¹²æ´»ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨é€šé“æ¥æŸ¥çœ‹ç›®å‰æœ‰å¤šå°‘ä¸ª worker åœ¨å·¥ä½œï¼Œå†™ä¸€ä¸ªç®€å•çš„ demo

*   åˆ›å»º j å’Œ worker channel é€šé“ï¼Œ
*   å­åç¨‹ 1 å†™ 15 ä¸ªä»»åŠ¡ç»™åˆ° j é€šé“ä¸­ï¼Œå†™å®Œ 15 ä¸ªä»»åŠ¡åˆ° j ä¸­ä¾¿å…³é—­è‡ªå·±çš„é€šé“ï¼ˆå› ä¸ºåç»­æˆ‘ä»¬éœ€è¦ä½¿ç”¨ for...range çš„æ–¹å¼è¯»å–é€šé“ï¼‰
*   ä½¿ç”¨ sync.WaitGroup ç®¡æ§å¼€è¾Ÿçš„ 3 ä¸ªåç¨‹ï¼Œæ¨¡æ‹Ÿ 3 ä¸ª å·¥äººå»å¹²æ´»
*   èƒ½å¤Ÿä»å†™å…¥æ•°æ®åˆ° worker channel é€šé“ä¸­ï¼Œåˆ™å¼€å§‹å¹²æ´»ï¼Œå¹²å®Œä¹‹åï¼Œä» worker channel é€šé“ä¸­è¯»å‡ºæ•°æ®

```
func main() {
    j := make(chan int, 15)
    worker := make(chan int, 3)

    go func() {
        for i := 0; i < 15; i++ {
            j <- i
        }
        close(j)
    }()

    var wg sync.WaitGroup

    for job := range j {
        wg.Add(1)
        go func(job int) {
            defer wg.Done()
            worker <- job
            // æ¨¡æ‹Ÿå¹²æ´»
            fmt.Println("æ­£åœ¨æ‰§è¡Œ job : ", job)
            time.Sleep(time.Second * 1)
            <-worker
        }(job)
    }

    wg.Wait()
    fmt.Println("program termination ... ")
}


```

æ„Ÿå…´è¶£çš„ xdm çš„å¯ä»¥å¤åˆ¶ä»£ç è¿è¡Œä¸€ä¸‹ï¼Œå¯ä»¥çœ‹åˆ°æ•ˆæœæ˜¯ 3 ä¸ª job ä¸€èµ·æ‰“å°ï¼Œé—´éš” 1 ç§’åï¼Œåˆæ˜¯ 3 ä¸ª job ä¸€èµ·æ‰“å°çš„ğŸ˜

select å’Œ channel é€šé“å¦‚ä½•ç»“åˆä½¿ç”¨ï¼Ÿ
--------------------------

1.  å¿ƒè·³

```
func main() {
    h := time.NewTicker(2 * time.Second)
    defer h.Stop()
    for {
        select {
        case <-h.C:
            // æ¨¡æ‹Ÿå¤„ç†å¿ƒè·³
            fmt.Println("hhh")
        }
    }
}


```

2.  ä½¿ç”¨ default

`select ...default` è¿™ä¸ªç»„åˆå°±ä¸å¿…è¿‡å¤šèµ˜è¿°äº†ï¼Œå°±æ˜¯åœ¨æˆ‘ä»¬é˜»å¡è¯»å–é€šé“æ•°æ®æ—¶ï¼Œè‹¥å½“å‰æ—¶é—´æ²¡æœ‰ä»ä»»ä½•ä¸€ä¸ªé€šé“ä¸­è¯»å–åˆ°æ•°æ®ï¼Œåˆ™é»˜è®¤èµ° default é‡Œé¢çš„é€»è¾‘

3.  è¶…æ—¶æœºåˆ¶

è¶…æ—¶æœºåˆ¶ä½¿ç”¨çš„ä¹Ÿæ˜¯éå¸¸é¢‘ç¹çš„ï¼Œå¾ˆå¤šæ—¶å€™ä¸ºäº†æ–¹ä¾¿ï¼Œå¯èƒ½æˆ‘ä»¬ä¼šä½¿ç”¨ä¾‹å¦‚`<- time.After(10 * time.Second)` çš„æ–¹å¼ï¼Œä½¿ç”¨è¿™ç§æ–¹å¼ï¼Œ**GO è¯­è¨€ä¼šç»´æŠ¤ä¸€ä¸ªæœ€å°å †ï¼Œå½“æ—¶é—´åˆ°äº†ï¼Œé€šé“è¢«å”¤é†’çš„æ—¶å€™ï¼Œå°±ä¼šä»æœ€å°å †é¡¶å–å‡º timer å¯¹è±¡ï¼Œå†æ‰§è¡Œ timer ä¸­çš„å‡½æ•°ï¼Œæ‰§è¡Œå®Œæ¯•ä¹‹åï¼Œè‡ªè¡Œå°±ä¼šåšåˆ é™¤ï¼Œè‡ªè¡Œå°±ä¼šåš** **GC**

å¯æ˜¯åœ¨ä¸Šè¿°è¿™ç§æ–¹å¼ä½¿ç”¨æ¯”è¾ƒå¤šçš„æ—¶å€™ï¼Œä¼šç»™ç¨‹åºå¸¦æ¥ GC çš„å‹åŠ›ï¼Œ**æˆ‘ä»¬å®Œå…¨å¯ä»¥å…¥å¦‚ä¸‹æ–¹å¼æ¥å®ç°è¶…æ—¶æœºåˆ¶ï¼Œæ˜¾ç¤ºçš„å»åš GC**

```
func main() {
    c := time.NewTimer(10 * time.Second)
    defer c.Stop()
    for {
        select {
        case <-c.C:
            fmt.Println("program overtime ")
            return
        }
    }
}


```

æ€»ç»“
--

æœ¬æ¬¡æ¼”ç¤ºäº†å…³äº nil channelï¼Œæœ‰ç¼“å†² channel ï¼Œæ— ç¼“å†² channel ï¼Œ select å¦‚ä½•ä¸ channel é…åˆä½¿ç”¨ï¼Œä¸Šè¿° demo å®Œå…¨å¯ä»¥å¤åˆ¶ä¸‹æ¥ï¼Œxdm å¯ä»¥è‡ªè¡Œè¿è¡Œï¼ŒæŸ¥çœ‹æ•ˆæœ

æ¬¢è¿ç‚¹èµï¼Œå…³æ³¨ï¼Œæ”¶è—
----------

æœ‹å‹ä»¬ï¼Œä½ çš„æ”¯æŒå’Œé¼“åŠ±ï¼Œæ˜¯æˆ‘åšæŒåˆ†äº«ï¼Œæé«˜è´¨é‡çš„åŠ¨åŠ›

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9e19850b0c884741a47692ccdfdba272~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp#?w=240&h=240&s=85012&e=webp&f=11&b=fbdbec)

å¥½äº†ï¼Œæœ¬æ¬¡å°±åˆ°è¿™é‡Œ

æŠ€æœ¯æ˜¯å¼€æ”¾çš„ï¼Œæˆ‘ä»¬çš„å¿ƒæ€ï¼Œæ›´åº”æ˜¯å¼€æ”¾çš„ã€‚æ‹¥æŠ±å˜åŒ–ï¼Œå‘é˜³è€Œç”Ÿï¼ŒåŠªåŠ›å‘å‰è¡Œã€‚

æˆ‘æ˜¯**é˜¿å…µäº‘åŸç”Ÿ**ï¼Œæ¬¢è¿ç‚¹èµå…³æ³¨æ”¶è—ï¼Œä¸‹æ¬¡è§~