> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/ydl0NgZQajuYulc28-ceCg)

我们如何在地图服务上找到附近的餐馆的？以下是一些幕后的设计细节。

有两个关键服务（见下图）：

![](https://mmbiz.qpic.cn/mmbiz_jpg/CwwQHM9Zcv7hlJp23NOK9lCPJjq3NkUGZRU4EibgMRXdo5BicdqD4pcMOQ6OORFdx1lP17GXjlkrf9FDdJ296yXA/640?wx_fmt=jpeg)

  

**- 商业服务 (Business Service)** - 添加 / 删除 / 更新餐厅信息 - 客户查看餐厅详情 **- 基于位置的服务 (Location-based Service)** - 给定一个半径和位置，返回附近餐馆的列表

餐馆的位置是如何存储在数据库中，以便基于位置的服务可以高效地返回附近的餐馆呢？

在数据库中存储餐馆的纬度和经度？当你需要计算你和每家餐馆之间的距离时，查询将非常低效。

加快搜索的一种方法是使用 geohash 算法。

首先，沿着本初子午线和赤道将地球划分为四个象限：

- 纬度范围 [-90, 0] 表示为 0

- 纬度范围 [0, 90] 表示为 1

- 经度范围 [-180, 0] 表示为 0

- 经度范围 [0, 180] 表示为 1

其次，将每个网格划分为四个更小的网格。每个网格可以由经度位和纬度位交替表示。

所以，当你想要搜索红色高亮网格中的附近餐馆时，你可以写如下 SQL：

SELECT * FROM geohash_index WHERE geohash LIKE `01%`

Geohash 有一些局限性。在一个网格中可能有很多餐馆，但在另一个网格中可能一个都没有（海洋）。所以有其他更复杂的算法来优化这个过程。如果你对细节感兴趣，就告诉我吧。

地图服务如何使用四叉树快速寻找附近的餐馆？
---------------------

四叉树是一种常用的数据结构，它通过递归地将二维空间划分为四个象限 (网格)，直到网格的内容满足某些条件（见第一张图）。

![](https://mmbiz.qpic.cn/mmbiz_jpg/CwwQHM9Zcv7hlJp23NOK9lCPJjq3NkUGK2Qb1B62H48awcKR88RTrj5m2CMFS9gICOtF9rjib8V6t6IL6bMIic4Q/640?wx_fmt=jpeg)

  

四叉树是一种**内存中的数据结构**，并不是数据库解决方案。它运行在每个 LBS（基于位置的服务，参见上周的文章）服务器上，数据结构在服务器启动时构建。

第二张图更详细地解释了四叉树的构建过程。根节点代表整个世界地图。根节点递归地被分解成 4 个象限，直到没有节点含有超过 100 个商家。

**如何使用四叉树获取附近的商家？**  
- 在内存中构建四叉树。

- 四叉树构建完成后，从根开始搜索并遍历树，直到我们找到搜索起点所在的叶子节点。

- 如果该叶子节点有 100 个商家，就返回该节点。否则，从其邻居那里添加商家，直到返回足够的商家。

**更新 LBS 服务器并重建四叉树**  
- 在服务器启动时，用 200 百万个商家在内存中构建四叉树可能需要几分钟的时间。

- 在构建四叉树的过程中，服务器不能提供服务。

- 因此，我们应该逐步地将服务器的新版本发布到一部分小服务器上。这样可以避免一次性将大部分服务器集群下线，导致服务中断。