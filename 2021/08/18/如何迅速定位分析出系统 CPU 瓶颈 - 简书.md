> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [www.jianshu.com](https://www.jianshu.com/p/7206ed927ad8)

一、CPU 性能指标（4 项）
===============

**1、CPU 使用率**
-------------

**CPU 使用率：**描述了非空闲时间占总 CPU 时间的百分比。根据 CPU 运行任务的不同，又被区分为：

**_用户 CPU 使用率，_**包括用户态 CPU 使用率（user）和低优先级用户态 CPU 使用率（nice），表示 CPU 在用户态运行的时间百分比。用户 CPU 使用率高，通常说明有应用程序比较繁忙。

_**系统 CPU 使用率**，_表示 CPU 在内核态运行的时间百分比（不包括中断）。系统 CPU 使用率高，说明内核比较繁忙。

**_等待 I/O 的 CPU 使用率_**，通常也称为 iowait，表示等待 I/O 的时间百分比。iowait 高，通常说明系统与硬件设备的 I/O 交互时间比较长。

**_软中断和硬中断的 CPU 使用率_**，分别表示内核调用软中断处理程序、硬中断处理程序的时间百分比。它们的使用率高，通常说明系统发生了大量的中断。

除了上面这些，还有在虚拟化环境中特有 CPU 使用率（实际设备忽略）。

2、**平均负载（Load Average）**
------------------------

平均负载：也就是系统的平均活跃进程数。它反应了系统的整体负载情况，主要包括三个数值，分别指过去 1 分钟、5 分钟和 15 分钟的平均负载。

理想情况下，**平均负载等于逻辑 CPU 个数，**这表示每个 CPU 都恰好被充分利用。如果平均负载大于逻辑 CPU 个数，就表示负载比较重了。

3、**进程上下文切换**
-------------

包含以下两种：

a、无法获取资源而导致的自愿上下文切换

b、被系统强制调度导致的非自愿上下文切换

上下文切换，本身是保证 Linux 正常运行的一项核心功能。**但过多的上下文切换，会将原本运行进程的 CPU 时间**，消耗在寄存器、内核栈以及虚拟内存等数据的保存和恢复上，缩短进程真正运行的时间，成为性能瓶颈

4、**CPU 缓存的命中率**
----------------

由于 CPU 发展的速度远快于内存的发展，CPU 的处理速度就比内存的访问速度快得多。这样，CPU 在访问内存的时候，免不了要等待内存的响应。为了协调这两者巨大的性能差距，CPU 缓存（通常是多级缓存）就出现了。

![](http://upload-images.jianshu.io/upload_images/15852353-a92691f5bcbffebd.png) CPU Cache 

CPU 缓存的速度介于 CPU 和内存之间，缓存的是热点的内存数据。根据不断增长的热点数据，这些缓存按照大小不同分为 L1、L2、L3 等三级缓存，其中 L1 和 L2 常用在单核中， L3 则用在多核中。从 L1 到 L3，三级缓存的大小依次增大，相应的，性能依次降低 ， 当然比内存还是好得多 。而它们的命中率，衡量的是 CPU 缓存的复用情况，命中率越高，则表示性能越好。

5、小结：

![](http://upload-images.jianshu.io/upload_images/15852353-f0b9eb60964dfc6c.png) CPU 的性能指标

**二、性能工具**
==========

从两个不同的维度来理解性能工具，做到活学活，把性能指标和性能工具联系起来。

**第一个维度，从 CPU 的性能指标出发。也就是说，当你要查看某个性能指标时，要清楚知道哪些工具可以做到。  
**

![](http://upload-images.jianshu.io/upload_images/15852353-20c1ac72fffc31a1.png) CPU 性能工具

**第二个维度，从工具出发。也就是当你已经安装了某个工具后，要知道这个工具能提供哪些指标**。

![](http://upload-images.jianshu.io/upload_images/15852353-6fce5a1fa00dd4f3.png)

三、如何迅速分析 CPU 性能瓶颈

**想弄清楚性能指标的关联性，就要通晓每种性能指标的工作原理**

![](http://upload-images.jianshu.io/upload_images/15852353-15977563adb51908.png) CPU 性能指标关系详解图

这张图里，列出了 top、vmstat 和 pidstat 分别提供的重要的 CPU 指标，并用虚线表示关联关系，对应出了性能分析下一步的方向。

通过这张图你可以发现，这三个命令，几乎包含了所有重要的 CPU 性能指标，比如：

从 top 的输出可以得到各种 CPU 使用率以及僵尸进程和平均负载等信息。

从 vmstat 的输出可以得到上下文切换次数、中断次数、运行状态和不可中断状态的进程数。

从 pidstat 的输出可以得到进程的用户 CPU 使用率、系统 CPU 使用率、以及自愿上下文切换和非自愿上下文切换情况。

另外，这三个工具输出的很多指标是相互关联的，所以，我也用虚线表示了它们的关联关系，举几个例子你可能会更容易理解。

四、例子分析
======

1、第一个例子：

pidstat 输出的进程用户 CPU 使用率升高，会导致 top 输出的用户 CPU 使用率升高。所以，当发现 top 输出的用户 CPU 使用率有问题时，可以跟 pidstat 的输出做对比，观察是否是某个进程导致的问题。而找出导致性能问题的进程后，就要用进程分析工具来分析进程的行为，比如使用 strace 分析系统调用情况，以及使用 perf 分析调用链中各级函数的执行情况。

2、第二个例子

top 输出的平均负载升高，可以跟 vmstat 输出的运行状态和不可中断状态的进程数做对比，观察是哪种进程导致的负载升高。如果是不可中断进程数增多了，那么就需要做 I/O 的分析，也就是用 dstat 或 sar 等工具，进一步分析 I/O 的情况。如果是运行状态进程数增多了，那就需要回到 top 和 pidstat，找出这些处于运行状态的到底是什么进程，然后再用进程分析工具，做进一步分析。

3、第三个例子

当发现 top 输出的软中断 CPU 使用率升高时，可以查看 /proc/softirqs 文件中各种类型软中断的变化情况，确定到底是哪种软中断出的问题。比如，发现是网络接收中断导致的问题，那就可以继续用网络分析工具 sar 和 tcpdump 来分析。

_文章出处来源：极客时间《Linux 性能优化》_