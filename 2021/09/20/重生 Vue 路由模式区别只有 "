> æœ¬æ–‡ç”± [ç®€æ‚¦ SimpRead](http://ksria.com/simpread/) è½¬ç ï¼Œ åŸæ–‡åœ°å€ [juejin.cn](https://juejin.cn/post/7004738881778090014)

è¯·ç”¨`Historyæ¨¡å¼`çš„å®ç°åŸç†å»æ¨¡æ‹Ÿ`hash`æ¨¡å¼, æŠŠ `URL` ä¸­çš„ `#` åé¢çš„å†…å®¹ä½œä¸ºè·¯ç”±åœ°å€ï¼Œå¯ä»¥é€šè¿‡ `hashchange` äº‹ä»¶ç›‘å¬è·¯ç”±åœ°å€çš„å˜åŒ–;

æœ¬æ–‡å°†ä¼šä¸ºä½ `å…·è±¡åŒ–`çš„ä»‹ç»è¿™ä¸¤ç§æ¨¡å¼, è®©ä½ ä¸å†æ˜¯æ­»è®°ç¡¬èƒŒè¿™ä¸¤ç§æ¨¡å¼çš„åŒºåˆ«, è®©åˆ«äººæåˆ°`"æ±‰å ¡"`, ä½ å°±ä¼šæƒ³åˆ° "ğŸ”", æåˆ°`"è–¯æ¡"`, å°±å¯ä»¥è”æƒ³åˆ° "ğŸŸ";

ç›¸å…³çŸ¥è¯†ç‚¹
-----

*   `Vue Router`åŸºç¡€ä¸å›é¡¾
*   `Hashæ¨¡å¼`å’Œ`Historyæ¨¡å¼`ä»‹ç»
*   `Hashæ¨¡å¼`å’Œ`Historyæ¨¡å¼`åŸç†æ¨¡æ‹Ÿ
*   ç”¨`historyæ¨¡å¼`çš„åŸç†å»æ¨¡æ‹Ÿ`hashæ¨¡å¼`(åŸç”ŸåŠ vue ç‰ˆ)
*   å®Œæˆé¢˜ç›®: ç”¨`historyæ¨¡å¼`çš„åŸç†å»æ¨¡æ‹Ÿ`hashæ¨¡å¼`, å¯ä»¥ä½¿ç”¨`hashchange`Â äº‹ä»¶ç›‘å¬è·¯ç”±åœ°å€çš„å˜åŒ–
*   éƒ¨åˆ†æºç ç®€å•æ¯”è¾ƒ

Vue Router åŸºç¡€ä¸å›é¡¾
----------------

å¯¹, ä½ æ²¡çœ‹é”™æ ‡é¢˜, å°±æ˜¯ä¸å›é¡¾, ä¸ºäº†`ç®€æ´`, å¤ªé•¿ä½ ä»¬ä¸æƒ³çœ‹, æˆ‘æ‡‚

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1ca1b68afed2435e906af163dfd03ff8~tplv-k3u1fbpfcp-watermark.awebp)

Hash æ¨¡å¼å’Œ History æ¨¡å¼ä»‹ç»
---------------------

### hash ä¸ history åŒºåˆ«åˆå°è±¡

![](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7368d2d046e345e4ad2f6d9c46847bd9~tplv-k3u1fbpfcp-watermark.awebp)

è¦æ˜¯ä½ åœ¨ç°åœ¨ç¬¬ä¸€æ—¶é—´æƒ³åˆ°çš„åŒºåˆ«è·Ÿè¿™ä¸ªåˆå°è±¡ä¸€æ ·, é‚£æ‚¨å¯¹è¿™ä¸¤ç§æ¨¡å¼çš„ç†è§£å¹¶ä¸æ·±å…¥, é¢è¯•å¯èƒ½è¿™ä¸ªéƒ¨åˆ†ä¼šå¤±åˆ†, ä»¥ä¸‹æˆ‘ä»¬å°†æ›´ä¸º`æ·±å…¥çš„å»äº†è§£`:

### Hash æ¨¡å¼

*   URL ä¸­`#`åé¢çš„å†…å®¹ä½œä¸ºè·¯å¾„åœ°å€
    
*   ç›‘å¬`hashchange`äº‹ä»¶
    
*   æ ¹æ®å½“å‰è·¯ç”±åœ°å€æ‰¾åˆ°å¯¹åº”ç»„ä»¶é‡æ–°æ¸²æŸ“
    

### history æ¨¡å¼:

*   é€šè¿‡`history.pushState()`æ–¹æ³•æ”¹å˜åœ°å€æ 
    
*   ç›‘å¬`popstate`äº‹ä»¶
    
*   æ ¹æ®å½“å‰è·¯ç”±åœ°å€æ‰¾åˆ°å¯¹åº”ç»„ä»¶é‡æ–°æ¸²æŸ“
    
*   `é€šè¿‡history.pushState,é€šè¿‡history.replaceState`: ä¸ä¼šè§¦å‘ popstate
    

ç›¸ä¿¡å¤§å®¶éƒ½å¾ˆç†Ÿæ‚‰è¿™ä¸ªå·®åˆ«, ä½†æ˜¯ä½ æœ‰æ²¡æœ‰æƒ³è¿‡? é€šè¿‡`history.pushState`æ”¹å˜åœ°å€æ 

ä¸ç›‘å¬`popstate`äº‹ä»¶å¹¶ä¸æ˜¯`historyçš„ä¸“åˆ©`,`hashæ¨¡å¼`ä¹Ÿèƒ½ä½¿ç”¨

![](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9d23169f67ec4850bdb8984cfa097920~tplv-k3u1fbpfcp-watermark.awebp)

ä¸ºäº†ææ¸…æ¥šè¿™ä¸ªé—®é¢˜, çœŸæ­£å»ç†è§£ä¸¤è€…çš„åŒºåˆ«, æˆ‘ä»¬å…ˆè¦ææ˜ç™½ä»¥ä¸‹è¿™äº›é—®é¢˜:

`hashæ¨¡å¼`:

*   ä»€ä¹ˆæ˜¯`é”šç‚¹("#")`, å®ƒæœ‰ä»€ä¹ˆç‰¹æ€§, æ€ä¹ˆç†è§£è¿™ä¸ªä¸œè¥¿
*   `hashchange`æœ‰ä»€ä¹ˆä½œç”¨?

`historyæ¨¡å¼`:

*   `history.pushState`ç”¨ä»€ä¹ˆä½œç”¨? è¿™é‡Œä¼šæ”¾åœ¨è·Ÿé”šç‚¹ä¸€èµ·è¯´ (å®ƒä»¬æœ‰ç›¸ä¼¼çš„ç‰¹æ€§)
*   `popstate`æœ‰ä»€ä¹ˆä½œç”¨?

### 1. [ä»€ä¹ˆæ˜¯é”šç‚¹ "#":](https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FLearn%2FCommon_questions%2FWhat_is_a_URL "https://developer.mozilla.org/zh-CN/docs/Learn/Common_questions/What_is_a_URL") [å¯ä»¥ç‚¹å‡»æ ‡é¢˜æŸ¥çœ‹ MDN è§£é‡Š]

> [www.example.com:80/path/to/myfâ€¦](https://link.juejin.cn?target=http%3A%2F%2Fwww.example.com%3A80%2Fpath%2Fto%2Fmyfile.htmlkey1%3Dvalue1%26key2%3Dvalue2%23SomewhereInTheDocument "http://www.example.com:80/path/to/myfile.htmlkey1=value1&key2=value2#SomewhereInTheDocument")

![](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/623cd1acf64f4044bb9a26f49370ac6c~tplv-k3u1fbpfcp-watermark.awebp)

> `#SomewhereInTheDocument`Â æ˜¯èµ„æºæœ¬èº«çš„å¦ä¸€éƒ¨åˆ†çš„é”šç‚¹. é”šç‚¹è¡¨ç¤ºèµ„æºä¸­çš„ä¸€ç§ â€œä¹¦ç­¾â€ï¼Œç»™æµè§ˆå™¨æ˜¾ç¤ºä½äºè¯¥â€œåŠ ä¹¦ç­¾â€ ä½ç½®çš„å†…å®¹çš„æ–¹å‘ã€‚ä¾‹å¦‚ï¼Œåœ¨ HTML æ–‡æ¡£ä¸Šï¼Œæµè§ˆå™¨å°†æ»šåŠ¨åˆ°å®šä¹‰é”šç‚¹çš„ä½ç½®; åœ¨è§†é¢‘æˆ–éŸ³é¢‘æ–‡æ¡£ä¸Šï¼Œæµè§ˆå™¨å°†å°è¯•è½¬åˆ°é”šä»£è¡¨çš„æ—¶é—´ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œ`ï¼ƒåé¢çš„éƒ¨åˆ†ï¼ˆä¹Ÿç§°ä¸ºç‰‡æ®µæ ‡è¯†ç¬¦ï¼‰ä»æ¥æ²¡æœ‰å‘é€åˆ°è¯·æ±‚çš„æœåŠ¡å™¨`ã€‚

> ä½ å¯èƒ½æƒ³åˆ°ä¸€ä¸ª URL ç±»ä¼¼æ™®é€šä¿¡ä»¶çš„åœ°å€ï¼šåè®®ä»£è¡¨ä½ è¦ä½¿ç”¨çš„é‚®æ”¿æœåŠ¡ï¼ŒåŸŸåæ˜¯åŸå¸‚æˆ–è€…åŸé•‡ï¼Œç«¯å£åˆ™åƒé‚®æ”¿ç¼–ç ï¼›è·¯å¾„ä»£è¡¨ç€ä½ çš„ä¿¡ä»¶æ‰€æœ‰é€’é€çš„å¤§æ¥¼ï¼›å‚æ•°åˆ™æä¾›é¢å¤–çš„ä¿¡æ¯ï¼Œå¦‚å¤§æ¥¼æ‰€åœ¨å•å…ƒï¼›`æœ€åï¼Œé”šç‚¹è¡¨ç¤ºä¿¡ä»¶çš„æ”¶ä»¶äºº`ã€‚

åœ¨ HTML æ–‡æ¡£ä¸Šæµè§ˆå™¨å°†æ»šåŠ¨åˆ°å®šä¹‰é”šç‚¹çš„ä½ç½®:

![](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1d5cadfd3ca54055ab5cefff7d49ddb7~tplv-k3u1fbpfcp-watermark.awebp)

æ€»ç»“:

*   ä½¿ç”¨é”šç‚¹, å°±ä¸ä¼šè¯·æ±‚æœåŠ¡å™¨
*   é¡µé¢ä¸åˆ·æ–°`(è¿™å¾ˆé‡è¦)`

### 2.[history.pushState():](https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FHistory%2FpushState "https://developer.mozilla.org/zh-CN/docs/Web/API/History/pushState") [å¯ä»¥ç‚¹å‡»æ ‡é¢˜æŸ¥çœ‹ MDN è§£é‡Š]

> ä»æŸç§ç¨‹åº¦æ¥è¯´, è°ƒç”¨Â `pushState()`Â å’ŒÂ `window.location = "#foo"`åŸºæœ¬ä¸Šä¸€æ ·, ä»–ä»¬éƒ½ä¼šåœ¨å½“å‰çš„ document ä¸­åˆ›å»ºå’Œæ¿€æ´»ä¸€ä¸ªæ–°çš„å†å²è®°å½•ã€‚ä½†æ˜¯Â `pushState()`Â æœ‰ä»¥ä¸‹ä¼˜åŠ¿ï¼š
> 
> *   æ–°çš„ URL å¯ä»¥æ˜¯ä»»ä½•å’Œå½“å‰ URL åŒæºçš„ URLã€‚ä½†æ˜¯è®¾ç½®Â [`window.location`](https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FWindow%2Flocation "https://developer.mozilla.org/zh-CN/docs/Web/API/Window/location")Â åªä¼šåœ¨ä½ åªè®¾ç½®é”šçš„æ—¶å€™æ‰ä¼šä½¿å½“å‰çš„ URLã€‚
> *   éå¼ºåˆ¶ä¿®æ”¹ URLã€‚ç›¸åï¼Œè®¾ç½®Â `window.location = "#foo";`Â ä»…ä»…ä¼šåœ¨é”šçš„å€¼ä¸æ˜¯ #foo æƒ…å†µä¸‹åˆ›å»ºä¸€æ¡æ–°çš„å†å²è®°å½•ã€‚
> *   å¯ä»¥åœ¨æ–°çš„å†å²è®°å½•ä¸­å…³è”ä»»ä½•æ•°æ®ã€‚`window.location = "#foo"`å½¢å¼çš„æ“ä½œï¼Œä½ åªå¯ä»¥å°†æ‰€éœ€æ•°æ®å†™å…¥é”šçš„å­—ç¬¦ä¸²ä¸­ã€‚

æ³¨æ„ï¼šÂ `pushState()`Â ä¸ä¼šé€ æˆÂ `hashchange (en-US)`Â äº‹ä»¶è°ƒç”¨, å³ä½¿æ–°çš„ URL å’Œä¹‹å‰çš„ URL åªæ˜¯é”šçš„æ•°æ®ä¸åŒã€‚

æ€»ç»“:

*   é¡µé¢ä¸åˆ·æ–°`(è¿™å¾ˆé‡è¦)`
*   å½“æˆ‘ä»¬`æ‰‹åŠ¨è¾“å…¥url`æˆ–è€…`åˆ·æ–°é¡µé¢`ä½¿ç”¨çš„ url æ˜¯ä¸å¸¦`'#'(é”šç‚¹)`çš„è¿˜æ˜¯ä¼šè¯·æ±‚æœåŠ¡å™¨, å½“æŒ‡å®šè·¯å¾„å¯»æ‰¾ä¸åˆ°æ–‡ä»¶ / ç›®å½•å°±ä¼š 404

> `http://168.238.7.88:8000/jerry/id`Â å¦‚æœåç«¯ç¼ºå°‘å¯¹`/jerry/id`Â çš„è·¯ç”±å¤„ç†ï¼Œå°†è¿”å› 404 é”™è¯¯ã€‚

### 3.[HashChange](https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FHashChangeEvent "https://developer.mozilla.org/zh-CN/docs/Web/API/HashChangeEvent"):[å¯ä»¥ç‚¹å‡»æ ‡é¢˜æŸ¥çœ‹ MDN è§£é‡Š]

> `HashChangeEvent`Â æ¥å£è¡¨ç¤ºä¸€ä¸ªå˜åŒ–äº‹ä»¶ï¼Œå½“ URL ä¸­çš„ç‰‡æ®µæ ‡è¯†ç¬¦å‘ç”Ÿæ”¹å˜æ—¶ï¼Œä¼šè§¦å‘æ­¤äº‹ä»¶ã€‚ç‰‡æ®µæ ‡è¯†ç¬¦æŒ‡ URL ä¸­Â `#`Â å·å’Œå®ƒä»¥åçš„éƒ¨åˆ†ã€‚

æ€»ç»“:

*   `åªè¦#å’Œå®ƒä»¥åçš„éƒ¨åˆ†æ”¹å˜`å°±ä¼šè§¦å‘è¿™ä¸ªäº‹ä»¶
*   ä¸è®ºä»€ä¹ˆæ–¹å¼, åªè¦`æ”¹å˜`

### 4.[popstate](https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FWindow%2Fpopstate_event "https://developer.mozilla.org/zh-CN/docs/Web/API/Window/popstate_event")[å¯ä»¥ç‚¹å‡»æ ‡é¢˜æŸ¥çœ‹ MDN è§£é‡Š]

> å½“æ´»åŠ¨å†å²è®°å½•æ¡ç›®æ›´æ”¹æ—¶ï¼Œå°†è§¦å‘`popstate`äº‹ä»¶ã€‚å¦‚æœè¢«æ¿€æ´»çš„å†å²è®°å½•æ¡ç›®æ˜¯é€šè¿‡å¯¹`history.pushStateï¼ˆï¼‰`çš„è°ƒç”¨åˆ›å»ºçš„ï¼Œæˆ–è€…å—åˆ°å¯¹`history.replaceStateï¼ˆï¼‰`çš„è°ƒç”¨çš„å½±å“ï¼Œ`popstate`äº‹ä»¶çš„ state å±æ€§åŒ…å«å†å²æ¡ç›®çš„çŠ¶æ€å¯¹è±¡çš„å‰¯æœ¬ã€‚

> éœ€è¦æ³¨æ„çš„æ˜¯è°ƒç”¨`history.pushState()`æˆ–`history.replaceState()`ä¸ä¼šè§¦å‘`popstate`äº‹ä»¶ã€‚åªæœ‰åœ¨åšå‡ºæµè§ˆå™¨åŠ¨ä½œæ—¶ï¼Œæ‰ä¼šè§¦å‘è¯¥äº‹ä»¶ï¼Œå¦‚ç”¨æˆ·ç‚¹å‡»æµè§ˆå™¨çš„å›é€€æŒ‰é’®ï¼ˆæˆ–è€…åœ¨ Javascript ä»£ç ä¸­è°ƒç”¨`history.back()`æˆ–è€…`history.forward()`æ–¹æ³•ï¼‰

æ€»ç»“:

*   popstate äº‹ä»¶åªæœ‰`history.go`,`history.back`,`history.forword`æˆ–è€…åšå‡º`æµè§ˆå™¨åŠ¨ä½œ`æ‰ä¼šè§¦å‘
*   `history.pushState`,`history.replaceState`: ä¸ä¼šè§¦å‘ popstate

![](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f97bc24761f044f990ccbfff805d38f4~tplv-k3u1fbpfcp-watermark.awebp)

åˆ«å…³ç½‘é¡µ, çœ‹æˆ‘ğŸ˜˜

`Hashæ¨¡å¼`å’Œ`Historyæ¨¡å¼`åŸç†æ¨¡æ‹Ÿ
------------------------

### æ¨¡æ‹Ÿæ¼”ç¤ºå‡†å¤‡: light-server(ç®€æ˜“æœåŠ¡å™¨)

```
// å®‰è£…
// yarn å…¨å±€å®‰è£…
yarn global add light-server
// npm å…¨å±€å®‰è£…
npm -g install light-server
å¤åˆ¶ä»£ç 
```

### Hash æ¨¡å¼

æ–°å»ºä¸€ä¸ª hash.html æ–‡ä»¶

```
<!DOCTYPE html>
<html lang="en">
<body>
<a href="#/">home</a>
<a href="#/about">about</a>
<a href="#/404">404</a>


<!-- æ¸²æŸ“è·¯ç”±å¯¹åº”çš„ç»„ä»¶ -->
<div id="routerView"></div>
</body>
<script>
let routerView = document.querySelector('#routerView')

let router = {
  '#/': 'homeComponent',
  '#/about': 'aboutComponent',
  '#/404': '404Component'
}

// æ¸²æŸ“å¯¹åº”çš„è·¯ç”±ç»„ä»¶
function render() {
  let hash = location.hash;
  routerView.innerHTML = router[hash]
}

// é¡µé¢é”šç‚¹å‘é€å˜åŒ–
window.addEventListener('hashchange', () => {
  render()
})

// é¡µé¢åŠ è½½
window.addEventListener('DOMContentLoaded', () => {
  
  // å½“ä¸å­˜åœ¨'#'æ—¶é‡å®šå‘åˆ°é¦–é¡µ#/
  location.hash || (location.hash = "/")
  // æ¸²æŸ“ç»„ä»¶
  render()
})
</script>
</html>
å¤åˆ¶ä»£ç 
```

åœ¨ç›®å½•ä¸‹è¿è¡Œ:

```
light-server -s . --port 3000 
å¤åˆ¶ä»£ç 
```

ç„¶åæ‰“å¼€è¦ä½ å‘½ 3000,[http://localhost:3000/hash.html](https://link.juejin.cn?target=http%3A%2F%2Flocalhost%3A3000%2Fhash.html "http://localhost:3000/hash.html") æŸ¥çœ‹æ•ˆæœ

ç®€å•è¯´ä¸€ä¸‹è¿™ä¸ª`hashåŸç†æ¨¡æ‹Ÿ`åšäº†äº›ä»€ä¹ˆ:

*   `renderå‡½æ•°`è´Ÿè´£æ¸²æŸ“é”šç‚¹å¯¹åº”è·¯ç”±ç»„ä»¶
*   `hashchange`è´Ÿè´£ç›‘å¬é”šç‚¹çš„`å˜åŒ–`, è¿™é‡Œçš„`å˜åŒ–`æ˜¯é‡ç‚¹, è®°ä½ä¸è®ºæ˜¯ä»€ä¹ˆæƒ…å†µçš„å˜åŒ–, åªè¦æœ‰é”šç‚¹é¡µé¢éƒ½ä¸ä¼šåˆ·æ–°, é‚£ä¹ˆæœ‰å‡ ç§æ–¹å¼å¯ä»¥æ”¹å˜ url çš„å‘¢?
    *   é€šè¿‡`aæ ‡ç­¾`(å¦‚ vue ä¸­çš„ router-link), ä¸Šè¿°æ¡ˆä¾‹ä½ åªçœ‹åˆ°é€šè¿‡ a æ ‡ç­¾æ›´æ”¹, ä½†æ˜¯ä¸‹é¢çš„å‡ ç§æ–¹å¼ä¹Ÿæ˜¯å¯ä»¥è§¦å‘`hashchange`çš„
    *   `routerç±»å°è£…`çš„æ–¹æ³• (å¦‚ router.push)
    *   `æ‰‹åŠ¨`è¾“å…¥æ”¹å˜åœ°å€æ  url
    *   æµè§ˆå™¨å‰è¿›åé€€æˆ–è€…åˆ©ç”¨`history.back,history.go`
*   `DOMContentLoaded`å½“é¡µé¢æ²¡æœ‰é”šç‚¹ ('#') æ—¶, æŠŠé¡µé¢é‡å®šå‘åˆ°é¦–é¡µ, å¹¶ä¸”æ¸²æŸ“é¦–é¡µå¯¹åº”çš„è·¯ç”±ç»„ä»¶

### History æ¨¡å¼

æ–°å»ºä¸€ä¸ª history.html

```
<!DOCTYPE html>
<html lang="en">
<body>
<a href="/">home</a>
<a href="/about">about</a>
<a href="/404">404</a>


<!-- æ¸²æŸ“è·¯ç”±å¯¹åº”çš„ç»„ä»¶ -->
<div id="routerView"></div>
</body>
<script>
let routerView = document.querySelector('#routerView')

let router = {
  '/': 'homeComponent',
  '/about': 'aboutComponent',
  '/404': '404Component'
}

// ç»‘å®šäº‹ä»¶
function listeners() {
  let aDoms = document.getElementsByTagName('a')
  Array.from(aDoms).forEach(el => el.addEventListener('click', function (e) {
      e.preventDefault()
      history.pushState(null, '', el.getAttribute('href'))
      render()
    })
  )
}

// æ¸²æŸ“å¯¹åº”çš„è·¯ç”±ç»„ä»¶
function render() {
  let pathname = location.pathname;
  routerView.innerHTML = router[pathname]
}

// é¡µé¢é”šç‚¹å‘é€å˜åŒ–
window.addEventListener('popstate', () => {
  render()
})

// é¡µé¢åŠ è½½
window.addEventListener('DOMContentLoaded', () => {
  listeners()
// æ¸²æŸ“ç»„ä»¶
  render()
})
</script>
</html>
å¤åˆ¶ä»£ç 
```

åœ¨ç›®å½•ä¸‹è¿è¡Œ:

```
light-server -s . --historyindex '/history.html' --port 3000 //æ¨¡æ‹ŸçœŸå®æœåŠ¡å™¨æ‰¾åˆ°è¯¥èµ„æºé‡å®šå‘åˆ°index.html(åˆå§‹é¡µé¢)  
å¤åˆ¶ä»£ç 
```

ç›¸å½“äº nginx é…ç½®:

```
try_files $uri $uri/ /index.html
å¤åˆ¶ä»£ç 
```

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/addacfbe0cdd45da9b26243b39b299a5~tplv-k3u1fbpfcp-watermark.awebp)

ç„¶åæ‰“å¼€è¦ä½ å‘½ 3000,[http://localhost:3000](https://link.juejin.cn?target=http%3A%2F%2Flocalhost%3A3000 "http://localhost:3000") æŸ¥çœ‹æ•ˆæœ

ç®€å•è¯´ä¸€ä¸‹è¿™ä¸ª`historyåŸç†æ¨¡æ‹Ÿ`åšäº†äº›ä»€ä¹ˆ:

*   `renderå‡½æ•°`è´Ÿè´£æ¸²æŸ“`pathname`å¯¹åº”è·¯ç”±ç»„ä»¶
*   `listeners`è´Ÿè´£ç»™æ¯ä¸€ä¸ª`aæ ‡ç­¾`ç»‘å®šä¸€ä¸ª`clickäº‹ä»¶`, è¯¥äº‹ä»¶:
    *   åˆ©ç”¨`pushstate`æŠŠè·¯ç”±åœ°å€çš„`pathname`ä¿®æ”¹ä¸ºå¯¹åº” a æ ‡ç­¾çš„ href å€¼
    *   `render`æ¸²æŸ“å¯¹åº”çš„è·¯ç”±
    *   `e.preventDefault()`é˜»æ­¢é»˜è®¤æ“ä½œ (é˜»æ­¢ a æ ‡ç­¾æ¥å®ç°è·³è½¬)
*   `popstate`åœ¨ä½¿ç”¨æµè§ˆå™¨å‰è¿›å, é€€æ—¶è§¦å‘`render`
*   `DOMContentLoaded`é¡µé¢åŠ è½½æ—¶è´Ÿè´£ç»™`aæ ‡ç­¾`æ³¨å†Œäº‹ä»¶å¹¶ä¸”æ¸²æŸ“é¦–é¡µå¯¹åº”çš„è·¯ç”±ç»„ä»¶

æ³¨æ„:

*   `e.preventDefault()`è¿™ä¸ªé»˜è®¤æ“ä½œå¾ˆé‡è¦, ä¸é˜»æ­¢é»˜è®¤å°±ä¼šé‡æ–°å‘æœåŠ¡å™¨å‘é€è¯·æ±‚, ä½¿é¡µé¢åˆ·æ–°
*   `pushstate`æ— è®ºå¸¦ä¸å¸¦é”šç‚¹, éƒ½ä¼šåŠ å…¥å†å²è®°å½•

### æ€»ç»“

*   ä¸¤ç§æ¨¡å¼éƒ½éœ€è¦åšä¸€ä¸ªåˆå§‹åŒ–äº‹ä»¶: æ¸²æŸ“åˆå§‹è·¯ç”±
*   hash æ¨¡å¼çš„æ ¸å¿ƒæ˜¯`hashchange`, ç›‘å¬è¯¥äº‹ä»¶, å½“å“ˆå¸Œå€¼å‘ç”Ÿæ”¹å˜è§¦å‘ç›¸åº”çš„å›è°ƒ:`render`è·¯ç”±æ¸²æŸ“ (å› ä¸ºä¸è®ºæ˜¯æ‰‹åŠ¨æ›´æ”¹ url åœ°å€è¿˜æ˜¯æµè§ˆå™¨å‰è¿›åé€€è¿˜æ˜¯å†…éƒ¨å°è£…çš„æ–¹æ³• push,router-link è·³è½¬, åªè¦å¸¦æœ‰é”šç‚¹ "#" æ”¹å˜éƒ½ä¼šè§¦å‘`hashchange`)
*   history æ¨¡å¼çš„æ ¸å¿ƒæ˜¯`pushstate`ä»¥åŠ`popstate`, å½“æ‰‹åŠ¨æ›´æ”¹è·¯ç”±å°±ä¼šé‡å®šå‘åˆ° index.html å†æ¬¡è§¦å‘åˆå§‹åŒ–äº‹ä»¶, å½“ä½¿ç”¨ router-link è·³è½¬æˆ–å†…éƒ¨å°è£…çš„ push æ–¹æ³•éƒ½è¦ç”¨`pushstate`å»æ›´æ”¹ url åœ°å€å¹¶ä¸”æ‰‹åŠ¨è§¦å‘`render`è·¯ç”±æ¸²æŸ“,`popstate`åˆ™ç›‘å¬æµè§ˆå™¨å‰è¿›åé€€, ç„¶åè§¦å‘`render`

### ç²¾ç®€æ€»ç»“

*   hash(æ ¸å¿ƒ`hashchange`):
    *   åˆå§‹åŒ– render
    *   æ‰€æœ‰è·³è½¬éƒ½æ˜¯ hashchange->render
        *   æ‰‹åŠ¨æ”¹å˜ url(hashchange->render)
        *   router-link è·³è½¬, push è·³è½¬ (hashchange->render)
        *   æµè§ˆå™¨å‰è¿›åé€€ (hashchange->render)
*   history(æ ¸å¿ƒ`pushstate,popstate`):
    *   åˆå§‹åŒ– render
    *   è·³è½¬æƒ…å†µ:
        *   æ‰‹åŠ¨æ”¹å˜ url(è§¦å‘é‡å®šå‘ -> åˆå§‹åŒ– render)
        *   router-link è·³è½¬, push è·³è½¬ (pushstate æ›´æ”¹ url, æ·»åŠ å†å²è®°å½•, è°ƒç”¨ render)
        *   æµè§ˆå™¨å‰è¿›åé€€ (popstate->render)

![](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0148f0f06e054c3aabd49f5f51279305~tplv-k3u1fbpfcp-watermark.awebp)

çœ‹åˆ°è¿™é‡Œè¿™é‡Œæˆ‘çŸ¥é“ä½ çœ‹æ‡‚äº†, ç»™ä¸ªååº”, ç‚¹èµè¯„è®º over,over...

ç”¨`historyæ¨¡å¼`çš„åŸç†å»æ¨¡æ‹Ÿ`hashæ¨¡å¼`(åŸç”ŸåŠ vue ç‰ˆ)
-------------------------------------

ç†è§£äº†æ ¸å¿ƒ, äº†è§£äº†æµç¨‹, é‚£å°±å¼€å§‹æ¨¡æ‹Ÿå§

### åŸç”Ÿç‰ˆ:

historyToHash.html:

```
<!DOCTYPE html>
<html lang="en">
<body>
<a href="/">home</a>
<a href="/about">about</a>
<a href="/404">404</a>


<!-- æ¸²æŸ“è·¯ç”±å¯¹åº”çš„ç»„ä»¶ -->
<div id="routerView"></div>
</body>
<script>
let routerView = document.querySelector('#routerView')

let router = {
  '/': 'homeComponent',
  '/about': 'aboutComponent',
  '/404': '404Component'
}

function listeners() {
  let aDoms = document.getElementsByTagName('a')
  Array.from(aDoms).forEach(el => el.addEventListener('click', function (e) {
      history.pushState(null, '', `#${el.getAttribute('href')}`)
      render()
    })
  )
}

//æ¸²æŸ“å¯¹åº”çš„è·¯ç”±ç»„ä»¶
function render() {

  let hash = location.hash.substr(1);
  routerView.innerHTML = router[hash]
}

//é¡µé¢é”šç‚¹å‘é€å˜åŒ–
window.addEventListener('popstate', () => {
  render()
})


//é¡µé¢åŠ è½½
window.addEventListener('DOMContentLoaded', () => {
  //å½“è¾“å…¥urlä¸å¸¦#çš„ç»™ç½‘é¡µåŠ #
  location.hash || (location.hash = "/")
  listeners()
  //æ¸²æŸ“ç»„ä»¶
  render()
})
</script>
</html>
å¤åˆ¶ä»£ç 
```

åœ¨ç›®å½•ä¸‹è¿è¡Œ:

```
light-server -s . --historyindex '/historyToHash.html' --port 3000 //æ¨¡æ‹ŸçœŸå®æœåŠ¡å™¨æ‰¾åˆ°è¯¥èµ„æºé‡å®šå‘åˆ°index.html(åˆå§‹é¡µé¢) 
å¤åˆ¶ä»£ç 
```

ç„¶åæ‰“å¼€è¦ä½ å‘½ 3000,[http://localhost:3000](https://link.juejin.cn?target=http%3A%2F%2Flocalhost%3A3000 "http://localhost:3000") æŸ¥çœ‹æ•ˆæœ

### vue ç‰ˆ:

æ–°å»ºä¸€ä¸ª historyToHashRouter.js æ–‡ä»¶, è£…è½½æ¨¡æ‹Ÿçš„ VueRouter ç±»

```
let _Vue = null
export default class VueRouter {
  static install(Vue) {
    // 1 åˆ¤æ–­å½“å‰æ’ä»¶æ˜¯å¦è¢«å®‰è£…
    if (VueRouter.install.installed) {
      return
    }
    VueRouter.install.installed = true
    // 2 æŠŠVueçš„æ„é€ å‡½æ•°è®°å½•åœ¨å…¨å±€
    _Vue = Vue
    // 3 æŠŠåˆ›å»ºVueçš„å®ä¾‹ä¼ å…¥çš„routerå¯¹è±¡æ³¨å…¥åˆ°Vueå®ä¾‹
    // _Vue.prototype.$router = this.$options.router
    _Vue.mixin({
      beforeCreate() {
        if (this.$options.router) {
          _Vue.prototype.$router = this.$options.router
        }
      }
    })
  }

  constructor(options) {
    this.options = options
    this.routeMap = {}
    // observable æŠŠæ•°æ®æ”¹ä¸ºå“åº”å¼
    this.data = _Vue.observable({
      current: ''
    })
    this.init()
  }

  init() {
    this.createRouteMap()
    this.initComponent(_Vue) // åˆå§‹åŒ–router-link,router-view
    this.initEvent() // ç›¸å½“äºåŸå£°ç‰ˆçš„åˆå§‹äº‹ä»¶
  }

  createRouteMap() {
    // éå†æ‰€æœ‰çš„è·¯ç”±è§„åˆ™ å§è·¯ç”±è§„åˆ™è§£ææˆé”®å€¼å¯¹çš„å½¢å¼å­˜å‚¨åˆ°routeMapä¸­
    this.options.routes.forEach(route => {
      this.routeMap[route.path] = route.component
    })
  }

  initComponent(Vue) {
    Vue.component('router-link', {
      props: {
        to: String
      },
      render(h) {
        return h('a', {
          on: {
            click: this.clickhander
          }
        }, [this.$slots.default])
      },
      methods: {
        clickhander(e) {
          // å†å²æ¨¡å¼
          history.pushState(null, '', `/#${this.to}`)
          this.$router.data.current = this.to // ç›¸å½“äºåŸç”Ÿç‰ˆçš„render
        }
      }
      // template:"<a :href='to'><slot></slot><>"
    })
    const self = this
    Vue.component('router-view', {
      render(h) {
        // self.data.current
        const cm = self.routeMap[self.data.current]
        return h(cm)
      }
    })
  }


  initEvent() {
    // å†å²æ¨¡å¼
    // å½“è¾“å…¥urlä¸å¸¦#çš„ç»™ç½‘é¡µåŠ #
    location.hash || (location.hash = "/")
    this.data.current = location.hash.substr(1) // ç›¸å½“äºåŸç”Ÿç‰ˆçš„render
    window.addEventListener('popstate', () => { // ç›‘å¬æµè§ˆå™¨å‰è¿›åé€€
      this.data.current = location.hash.substr(1) // ç›¸å½“äºåŸç”Ÿç‰ˆçš„render
    })
  }
}
å¤åˆ¶ä»£ç 
```

å®Œæˆé¢˜ç›®: ç”¨`historyæ¨¡å¼`çš„åŸç†å»æ¨¡æ‹Ÿ`hashæ¨¡å¼`, å¯ä»¥ä½¿ç”¨`hashchange`Â äº‹ä»¶ç›‘å¬è·¯ç”±åœ°å€çš„å˜åŒ–
--------------------------------------------------------------

ç»ˆäº, æ¥åˆ°è¿™é‡Œ, æˆ‘ä¹Ÿçœ‹æ‡‚äº†é¢˜ç›®äº†, æ•´:

```
let _Vue = null
export default class VueRouter {
  static install(Vue) {
    // 1 åˆ¤æ–­å½“å‰æ’ä»¶æ˜¯å¦è¢«å®‰è£…
    if (VueRouter.install.installed) {
      return
    }
    VueRouter.install.installed = true
    // 2 æŠŠVueçš„æ„é€ å‡½æ•°è®°å½•åœ¨å…¨å±€
    _Vue = Vue
    // 3 æŠŠåˆ›å»ºVueçš„å®ä¾‹ä¼ å…¥çš„routerå¯¹è±¡æ³¨å…¥åˆ°Vueå®ä¾‹
    // _Vue.prototype.$router = this.$options.router
    _Vue.mixin({
      beforeCreate() {
        if (this.$options.router) {
          _Vue.prototype.$router = this.$options.router
        }
      }
    })
  }

  constructor(options) {
    this.options = options
    this.routeMap = {}
    // observable
    this.data = _Vue.observable({
      current: ''
    })
    this.init()
  }

  init() {
    this.createRouteMap()
    this.initComponent(_Vue)
    this.initEvent()
  }

  createRouteMap() {
    // éå†æ‰€æœ‰çš„è·¯ç”±è§„åˆ™ å§è·¯ç”±è§„åˆ™è§£ææˆé”®å€¼å¯¹çš„å½¢å¼å­˜å‚¨åˆ°routeMapä¸­
    this.options.routes.forEach(route => {
      this.routeMap[route.path] = route.component
    })
  }

  initComponent(Vue) {
    Vue.component('router-link', {
      props: {
        to: String
      },
      render(h) {
        return h('a', {
          on: {
            click: this.clickhander
          }
        }, [this.$slots.default])
      },
      methods: {
        clickhander(e) {
        // å†å²æ¨¡å¼
        history.pushState(null, '', `/#${this.to}`)
        this.$router.data.current = this.to // ç›¸å½“äºrender,pushStateä¸ä¼šè§¦å‘hashchange
        }
      }
      // template:"<a :href='to'><slot></slot><>"
    })
    const self = this
    Vue.component('router-view', {
      render(h) {
        // self.data.current
        const cm = self.routeMap[self.data.current]
        return h(cm)
      }
    })
  }


  initEvent() {
    // hashchange
    //å½“è¾“å…¥urlä¸å¸¦#çš„ç»™ç½‘é¡µåŠ #
    location.hash || (location.hash = "/")
    this.data.current = window.location.hash.substr(1) || '/'
    window.addEventListener('hashchange', () => {
      this.data.current = window.location.hash.substr(1) || '/'
    })
  }
}
å¤åˆ¶ä»£ç 
```

*   è¿™é‡Œåœ¨ router-link è·³è½¬è¿˜æ˜¯ä½¿ç”¨äº†`pushstate`
*   ä½†æ˜¯`popstate`æ²¡æœ‰ä½¿ç”¨, å› ä¸º`hashchange`åŒæ ·ä¹Ÿå¯ä»¥ç›‘å¬åˆ°æµè§ˆå™¨çš„å‰è¿›åé€€ (åªè¦ url å¸¦æœ‰é”šç‚¹ "#")

### çœ‹åˆ°è¿™é‡Œ, ä½ æˆ–è®¸ä¼šæœ‰ä¸€ä¸ªç–‘é—®, æ—¢ç„¶ä½¿ç”¨ history æ¨¡å¼æ¨¡æ‹Ÿ hash æ¨¡å¼æ˜¯å¯è¡Œçš„, ä¸ºä»€ä¹ˆé¢˜ç›®åˆæå‡ºå¯ä»¥ä½¿ç”¨ hashchange å‘¢?

æˆ‘çš„ä¸ªäººçŒœæƒ³:

*   å› ä¸º dev-server åšä¸åˆ°é¡µé¢é‡å®šå‘çš„æ•ˆæœ, çœŸæ­£çš„ history éœ€è¦é…ç½® nginx é‡å®šå‘
*   å› æ­¤ä½¿ç”¨ hashchange æ¥æ¨¡æ‹Ÿè¿™ç§æ•ˆæœ

éƒ¨åˆ†æºç ç®€å•æ¯”è¾ƒ
--------

ä¸€æåˆ°æºç , ä½ ä»¬å°±è¿™æ ·, åˆ«æ…Œ, æˆ‘ä»¬è¿™æ¬¡åªæ˜¯ç®€å•çœ‹çœ‹, ç²—ç•¥ç²—ç•¥çœ‹ä¸€ä¸‹ (vue-router ç‰ˆæœ¬ 3.1.6):

![](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5769289dbe124be4a1afa3f53e6f4308~tplv-k3u1fbpfcp-watermark.awebp)

ä¸çŸ¥é“ä½ ä»¬è¿˜è®°å¾—æœ¬æ–‡å¼€å¤´æåˆ°è¿‡çš„:

> ä½†æ˜¯ä½ æœ‰æ²¡æœ‰æƒ³è¿‡? é€šè¿‡`history.pushState`æ”¹å˜åœ°å€æ ä¸ç›‘å¬`popstate`äº‹ä»¶å¹¶ä¸æ˜¯`historyçš„ä¸“åˆ©`,`hashæ¨¡å¼`ä¹Ÿèƒ½ä½¿ç”¨

```
// index.js
export default class VueRouter {

    ...
  constructor (options: RouterOptions = {}) {
    ...

    switch (mode) {
      case 'history': // å†å²æ¨¡å¼
        this.history = new HTML5History(this, options.base)
        break
      case 'hash':   // å“ˆå¸Œæ¨¡å¼
        this.history = new HashHistory(this, options.base, this.fallback)
        break
      case 'abstract':
        this.history = new AbstractHistory(this, options.base)
        break
      default:
        if (process.env.NODE_ENV !== 'production') {
          assert(false, `invalid mode: ${mode}`)
        }
    }
  }
}
å¤åˆ¶ä»£ç 
```

### HashHistory

æœ‰æ²¡æœ‰ä¸€ç‚¹ç–‘æƒ‘? è¿™ä¸ª`pushState`, æœ‰ç‚¹ä¸œè¥¿? å“ˆå¸Œæ¨¡å¼éš¾é“ä¹Ÿç”¨å†å²æ¨¡å¼çš„ä¸œè¥¿?

```
// hash.js
function pushHash (path) {
  if (supportsPushState) {
    pushState(getUrl(path))
  } else {
    window.location.hash = path
  }
}

export class HashHistory extends History {
    ...
    push (location: RawLocation, onComplete?: Function, onAbort?: Function) {
      const { current: fromRoute } = this
      this.transitionTo(
        location,
        route => {
          pushHash(route.fullPath)
          handleScroll(this.router, route, fromRoute, false)
          onComplete && onComplete(route)
        },
        onAbort
      )
    }
    setupListeners () {
      ...    
      // ä½ ç–‘æƒ‘äº†å—?,ä¹Ÿç”¨popstate
      const eventType = supportsPushState ? 'popstate' : 'hashchange'
      window.addEventListener(
        eventType,
        handleRoutingEvent
      )
      this.listeners.push(() => {
        window.removeEventListener(eventType, handleRoutingEvent)
      })
    }
}    
å¤åˆ¶ä»£ç 
```

### HTML5History

```
// html5.js
export class HTML5History extends History {
    ...
    push (location: RawLocation, onComplete?: Function, onAbort?: Function) {
      const { current: fromRoute } = this
      this.transitionTo(location, route => {
        pushState(cleanPath(this.base + route.fullPath))
        handleScroll(this.router, route, fromRoute, false)
        onComplete && onComplete(route)
      }, onAbort)
    }
    
    setupListeners () {
      ...    
     window.addEventListener('popstate', handleRoutingEvent)
     this.listeners.push(() => {
       window.removeEventListener('popstate', handleRoutingEvent)
     })
    }
}    
å¤åˆ¶ä»£ç 
```

ä»–ä»¬ä½¿ç”¨çš„`pushState`æ–¹æ³•éƒ½æ˜¯ä¸€æ ·çš„;

### æ€»ç»“

ç›¸ä¿¡èªæ˜çš„ä½ å·²ç»ä»ä¸­å‘ç°äº†ç«¯å€ª:

*   å“ˆå¸Œæ¨¡å¼ä¹Ÿä½¿ç”¨äº†å†å²æ¨¡å¼çš„åŸç†, å¹¶ä¸”åšäº†`å‘ä¸‹å…¼å®¹`: å½“æµè§ˆå™¨ä¸æ”¯æŒ history çš„æ—¶å€™å¯ä»¥ä½¿ç”¨ hash
*   åœ¨æŸç§ç¨‹åº¦ä¸Šå®ƒä»¬è¿˜çœŸçš„åªæ˜¯åªæœ‰ #çš„åŒºåˆ«
*   é¢è¯•å®˜è¦æ˜¯è¿™ä¹ˆé—®ä½ , ä½ è¦æ˜¯å›ç­”åªæœ‰`"#"`çš„åŒºåˆ«è¯·ä½ ä¸€å®šä¸€å®šè¦å…ˆ`è¯´æ˜å®ƒä»¬çš„æ ¸å¿ƒ`, è¯´ä½ çš„`ç†è§£`, å†è¯´`æºç `, åˆ«çœŸæ†¨æ†¨è¯´åªæœ‰`"#"`, ç„¶åä¸ä½œä»»ä½•è§£é‡Š

æœ€å
--

çœ‹æ‡‚äº†è¯·ç»™æˆ‘ç‚¹ä¸ªğŸ‘, è¿™æ˜¯å¯¹æˆ‘è«å¤§çš„æ”¯æŒ, æ²¡çœ‹æ‡‚å¯ä»¥å…ˆç‚¹èµç„¶åè¯„è®º`"ä½œè€…å›å®¶ç­‰é€šçŸ¥"`, è¦æ˜¯æœ¬æ–‡æœ‰æè¿°ä¸æ¸…æ¥šæˆ–è€…é”™è¯¯çš„åœ°æ–¹è¯·è¯„è®º, æˆ‘ä¼šç«‹å³å›åº”æ›´æ”¹, æ„Ÿè°¢å¤§å®¶â˜ºï¸