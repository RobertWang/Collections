> æœ¬æ–‡ç”± [ç®€æ‚¦ SimpRead](http://ksria.com/simpread/) è½¬ç ï¼Œ åŸæ–‡åœ°å€ [mp.weixin.qq.com](https://mp.weixin.qq.com/s/u-VWrrdlkRzKs7u04EPV-g)

> â
> 
> è¿™ä¸€ç”Ÿå¬è¿‡è®¸å¤šé“ç†ï¼Œä½†è¿˜æ˜¯è¿‡ä¸å¥½è¿™ä¸€ç”Ÿï¼Œè¿™æ˜¯å› ä¸ºç¼ºå°‘çœŸæ­£çš„åŠ¨æ‰‹å®è·µï¼Œå…‰å¬é“ç†ï¼Œç¼ºå°‘åŠ¨æ‰‹å®è·µçš„è¿‡ç¨‹ï¼Œå­¦ä¹ éš¾å…ä¼šè®©äººè§‰å¾—å‘³åŒåš¼èœ¡ï¼Œæ‰€ä»¥æˆ‘çš„åˆ†äº«éƒ½æ¯”è¾ƒå€¾å‘äºå®è·µï¼Œåœ¨ä¸€æ¬¡æ¬¡åŠ¨æ‰‹å®è·µçš„è¿‡ç¨‹ä¸­æ„Ÿå—çŸ¥è¯†åŸæœ¬çº¯çœŸçš„æ¨¡æ ·ã€‚
> 
> â

å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯è“èƒ–å­ï¼Œå¾€å¾€ä»äº‹äº’è”ç½‘å¼€å‘çš„åŒå­¦éƒ½å¬è¿‡ cdn è¿™ä¸ªè¯ï¼Œä¸è¿‡å¯¹äºåˆšå…¥è¡Œçš„åŒå­¦å¯èƒ½ä¼šå¯¹è¿™ä¸ªæ¦‚å¿µæ¯”è¾ƒæ¨¡ç³Šï¼Œä»Šå¤©æˆ‘ä»¬å°±æ¥èŠèŠå®ƒï¼Œå¹¶ä¸”æˆ‘ä¼šåœ¨åŸç†çš„åŸºç¡€ä¸Šåœ¨æœ¬åœ°æ­å»ºä¸€ä¸ª cdn ç¯å¢ƒï¼Œæ¨¡æ‹ŸåŸŸåé…ç½®ï¼Œå›æºï¼Œä»¥åŠç¼“å­˜çš„è¿‡ç¨‹ã€‚

æœ¬èŠ‚æºç å·²ç»ä¸Šä¼ åˆ° github

```
https://github.com/HobbyBear/cdndemo


```

ç°åœ¨ï¼Œè®©æˆ‘ä»¬å¼€å§‹å§ã€‚

cdn åŸç†ä»‹ç»
--------

é¦–å…ˆï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹ä¸ºä»€ä¹ˆè¦ç”¨ cdnï¼Œæ¯”å¦‚ä¸€ä¸ªä¸“æ³¨åšè§†é¢‘æ’­æ”¾æˆ–è€…å›¾ç‰‡é˜…è§ˆçš„ç½‘ç«™ï¼Œå½“ç”¨æˆ·æµè§ˆç½‘ç«™æ—¶ï¼Œéœ€è¦ä»ç½‘ç«™æ‹‰å–å›¾ç‰‡æˆ–è€…è§†é¢‘èµ„æºï¼Œè¿™å°†äº§ç”Ÿæµé‡è´¹ç”¨ï¼Œå¹¶ä¸”ï¼Œå¦‚æœç”¨æˆ·é‡Œç½‘ç«™æœåŠ¡å™¨è¶Šè¿œï¼Œäº§ç”Ÿçš„æµé‡è´¹ç”¨å°†è¶Šé«˜ã€‚è€Œ cdn çš„åŸç†åˆ™æ˜¯å°†è§†é¢‘æˆ–è€…å›¾ç‰‡èµ„æºç¼“å­˜åœ¨ç¦»ç”¨æˆ·æ¯”è¾ƒè¿‘çš„æœåŠ¡å™¨ä¸Šï¼Œè¿™æ ·æ—¢æå‡äº†å“åº”é€Ÿç‡ï¼ŒåˆèŠ‚çº¦äº†æµé‡è´¹ã€‚

æ¥çœ‹ä¸‹ä½¿ç”¨ cdn åï¼Œç”¨æˆ·è®¿é—®ç½‘ç«™çš„è¿‡ç¨‹ã€‚

![](https://mmbiz.qpic.cn/sz_mmbiz_png/81178hAUFMicze0mKCb4LY1jctCXDsBPI6vRThWiboagpKhcUkaPicsrlLxS8qJfwAQX5e8D0jPncdV0ayulRFQQQ/640?wx_fmt=png)img.png

å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œå‡è®¾ç”¨æˆ·è‡ªå·±çš„æƒ³è¦åŠ é€Ÿçš„åŸŸåæ˜¯ web.cdn.testï¼Œå¦‚æœç”¨æˆ·æƒ³å¯¹è¿™ä¸ªåŸŸåè¿›è¡ŒåŠ é€Ÿï¼Œé¦–å…ˆè¦å» cdn æœåŠ¡å•†é‚£é‡Œé…ç½®ä¸Šè¿™ä¸ª**ã€ŒåŠ é€ŸåŸŸåã€**å’Œ**ã€Œæºç«™æœåŠ¡åœ°å€ã€**ï¼Œæ¥ç€ cdn æœåŠ¡å•†ä¼šç”Ÿæˆä¸€ä¸ªåŸŸååœ°å€, è¿™é‡Œå‡è®¾ä¸º web.cdn.test.c.lanpangziï¼Œè€Œç”¨æˆ·è‡ªå·±éœ€è¦å»è‡ªå·±çš„ dns æœåŠ¡å•†é‚£é‡Œå°†åŠ é€ŸåŸŸå web.cdn.test æŒ‡å‘è¿™ä¸ªæ–°çš„åŸŸååœ°å€ï¼Œè¿™ç§å°†ä¸€ä¸ªåŸŸåæŒ‡å‘å¦ä¸€ä¸ªåŸŸåçš„è®°å½•è¢«ç§°ä½œ**ã€Œcnameã€**è®°å½•ã€‚

ç»è¿‡ä¸Šè¿°æ­¥éª¤åï¼Œå¯¹åŸŸå web.cdn.test çš„è®¿é—®ä¼šè¢«æŒ‡å‘ web.cdn.test.c.lanpangzi, ä½†ç›®å‰è¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œæ–°çš„åŸŸå web.cdn.test.c.lanpangzi åº”è¯¥ç”± cdn æœåŠ¡å•†è‡ªå·±çš„ dns è°ƒåº¦ç³»ç»Ÿå»è§£æï¼Œè¿™æ · cdn æœåŠ¡å•†æ‰èƒ½å°†è¾¹ç¼˜èŠ‚ç‚¹çš„ ip è¿”å›ç»™ç”¨æˆ·ï¼Œé‚£æœ¬åœ° dns æœåŠ¡å™¨æ€ä¹ˆçŸ¥é“ web.cdn.test.c.lanpangzi è¿™ä¸ªåŸŸåè¦äº¤ç»™å“ªå°æœºå™¨å»è§£æå‘¢ï¼Ÿ

åŸå› æ˜¯è¿™æ ·çš„ï¼Œcdn æœåŠ¡å•†åœ¨æ³¨å†Œè‡ªå·±çš„ä¸»åŸŸåæ—¶ (è¿™é‡Œçš„ä¸»åŸŸåæ˜¯ langpangzi.) ï¼Œå‘ dns æœåŠ¡å™¨æ³¨å†Œäº†ä¸€æ¡**ã€Œnsã€**è®°å½•ï¼Œns è®°å½•å¯ä»¥æŒ‡å®šå°†æŸä¸ªåŸŸåçš„è§£æäº¤ç»™å“ªä¸€å° dns æœåŠ¡å™¨è§£æï¼Œæ¯”å¦‚è¿™é‡Œï¼Œcdn æœåŠ¡å•†å°±æŠŠ**ã€Œc.langpangzi.ã€** åŸŸåçš„è§£ææŒ‡å‘äº† cdn æœåŠ¡å•†è‡ªå·±çš„ dns æœåŠ¡å™¨ã€‚

å®Œæˆäº†è¿™ä¸€æ­¥ï¼Œç”¨æˆ·è‡ªå·±çš„åŠ é€ŸåŸŸåæœ€ç»ˆå°±ä¼šè¢« cdn æœåŠ¡å•†çš„ dns æœåŠ¡å™¨å»è§£æäº†ï¼Œcdn æœåŠ¡å•†ä¸€èˆ¬åœ¨å…¨çƒå„åœ°éƒ½æœ‰è‡ªå·±çš„èŠ‚ç‚¹ï¼Œæ‰€ä»¥å®ƒä¼šæ ¹æ®ç”¨æˆ·çš„ ip å»ç­›é€‰ä¸€ä¸ªç¦»ç”¨æˆ·æ¯”è¾ƒè¿‘èŠ‚ç‚¹ ip è¿”å›ï¼Œè¿™äº›èŠ‚ç‚¹è¢«ç§°ä½œ**ã€Œè¾¹ç¼˜èŠ‚ç‚¹ã€** ï¼Œè¿™æ ·ç”¨æˆ·çš„è¯·æ±‚å°±èƒ½å°±è¿‘è®¿é—®äº†ã€‚

æœ¬åœ°æ­å»ºä¸€ä¸ª cdn
----------

æˆ‘ä»¬æŠŠä¸Šé¢çš„è¯·æ±‚è¿‡ç¨‹ä¸ cdn æ¶æ„åœ¨æœ¬åœ°æ¨¡æ‹Ÿä¸‹ï¼ŒæŠŠè‡ªå·±æƒ³è±¡æˆä¸€ä¸ª cdn æœåŠ¡å•†ï¼Œæˆ‘ä»¬å°†ä¼šæ­å»º cdn çš„åŸŸåè°ƒåº¦ä¸­å¿ƒï¼Œå’Œè¾¹ç¼˜èŠ‚ç‚¹ï¼Œç„¶åå…è®¸ç”¨æˆ·æä¾›åŠ é€ŸåŸŸåå’Œå›æºæœåŠ¡å™¨ç»™æˆ‘è¿›è¡Œé…ç½®ã€‚

### æ­å»º dns æœåŠ¡å™¨

æˆ‘ä»¬å…ˆæ¥æ­å»ºä¸€ä¸ª dns æœåŠ¡å™¨ï¼Œå› ä¸ºæ— è®ºæ˜¯ cdn è¿˜æ˜¯ç”¨æˆ·æœ¬èº«éƒ½éœ€è¦è¿›è¡Œä¸€äº› dns åŸŸåé…ç½®ï¼Œä½ å¯ä»¥æŠŠå½“å‰è¿™ä¸ª dns æœåŠ¡å™¨æƒ³è±¡æˆç¬¬ä¸‰æ–¹ dns è¿è¥å•†ã€‚

æˆ‘ä»¬ç”¨ dnsmasq åœ¨æœ¬åœ°è¿›è¡Œ dns æœåŠ¡å™¨çš„æ­å»ºï¼Œæˆ‘æœ¬åœ°æœºå™¨ç”¨çš„ macï¼Œå®‰è£…å‘½ä»¤å¦‚ä¸‹:

```
brewÂ installÂ Â dnsmasq

==>Â Dependencies
Build:Â pkg-configÂ âœ”
==>Â Caveats
ToÂ startÂ dnsmasqÂ nowÂ andÂ restartÂ atÂ startup:
Â Â sudoÂ brewÂ servicesÂ startÂ dnsmasq
Or,Â ifÂ youÂ don'tÂ want/needÂ aÂ backgroundÂ serviceÂ youÂ canÂ justÂ run:
Â Â /opt/homebrew/opt/dnsmasq/sbin/dnsmasqÂ --keep-in-foregroundÂ -CÂ /opt/homebrew/etc/dnsmasq.confÂ -7Â /opt/homebrew/etc/dnsmasq.d,*.conf
==>Â Analytics
install:Â 0Â (30Â days),Â 0Â (90Â days),Â 0Â (365Â days)
install-on-request:Â 0Â (30Â days),Â 0Â (90Â days),Â 0Â (365Â days


```

æ¥ç€éœ€è¦å¯¹å…¶é…ç½®æ–‡ä»¶è¿›è¡Œä¿®æ”¹ï¼Œé…ç½®ä¸Šæ¸¸æœåŠ¡å™¨ï¼Œä»¥åŠé…ç½®å½“å‰ dns æœåŠ¡å™¨èƒ½å¤Ÿè§£æçš„åŸŸå

ä»å®‰è£…çš„ä¿¡æ¯å¯ä»¥çœ‹å‡ºï¼Œå…¶é…ç½®æ–‡ä»¶æ˜¯åœ¨ / opt/homebrew/etc/dnsmasq.conf è¿™ä¸ªä½ç½®ï¼Œè¿™é‡Œæˆ‘ç›´æ¥ç»™å‡ºæˆ‘çš„é…ç½®ä¿¡æ¯

```
#Â é…ç½®ä¸Šè¡ŒDNSï¼Œå¯¹åº”no-resolv
resolv-file=/Users/xiongchuanhong/dnsmasq.conf
#Â è¿è¡Œè¿›ç¨‹ä»¥å“ªä¸ªç”¨æˆ·èº«ä»½è¿è¡Œï¼Œç›´æ¥ç”¨rootï¼Œå› ä¸ºdnsmasqçš„é…ç½®æ¶‰åŠåˆ°æƒé™é—®é¢˜
user=root
#Â é…ç½®dnsmqsqè¿è¡Œæ—¥å¿—ï¼Œå¯¹æ’é”™å¾ˆé‡è¦
log-facility=/Users/xiongchuanhong/logs/dnsmasq.log
#Â resolv.confå†…çš„DNSå¯»å€ä¸¥æ ¼æŒ‰ç…§ä»ä¸Šåˆ°ä¸‹é¡ºåºæ‰§è¡Œï¼Œç›´åˆ°æˆåŠŸä¸ºæ­¢
strict-order
#Â DNSè§£æhostsæ—¶å¯¹åº”çš„hostsæ–‡ä»¶ï¼Œå¯¹åº”no-hosts
addn-hosts=/etc/hosts
cache-size=1024
#Â å¤šä¸ªIPç”¨é€—å·åˆ†éš”ï¼Œ192.168.x.xè¡¨ç¤ºæœ¬æœºçš„ipåœ°å€ï¼Œåªæœ‰127.0.0.1çš„æ—¶å€™è¡¨ç¤ºåªæœ‰æœ¬æœºå¯ä»¥è®¿é—®ã€‚
#Â é€šè¿‡è¿™ä¸ªè®¾ç½®å°±å¯ä»¥å®ç°åŒä¸€å±€åŸŸç½‘å†…çš„è®¾å¤‡ï¼Œé€šè¿‡æŠŠç½‘ç»œDNSè®¾ç½®ä¸ºæœ¬æœºIPä»è€Œå®ç°å±€åŸŸç½‘èŒƒå›´å†…çš„DNSæ³›è§£æ(æ³¨ï¼šæ— æ•ˆIPæœ‰å¯èƒ½å¯¼è‡³æœåŠ¡æ— æ³•å¯åŠ¨ï¼‰192.168.17.150Â æ˜¯æˆ‘æœ¬åœ°æœºå™¨å†…ç½‘ip
listen-address=127.0.0.1,192.168.17.150
#Â ç›¸å½“äºnsè®°å½•ï¼Œc.lanpangziçš„åŸŸåä»¥åŠå…¶å­åŸŸåéƒ½ä¼šç”±æœ¬åœ°1053ç«¯å£çš„è¿›ç¨‹å»è¿›è¡Œè§£æ
server=/c.lanpangzi/127.0.0.1#1053
#Â cnameè®°å½•ï¼Œè®¿é—®web.cdn.testÂ çš„åŸŸåéƒ½ä¼šæŒ‡å‘web.cdn.test.c.lanpangziÂ 
cname=web.cdn.test,web.cdn.test.c.lanpangzi
#Â é‡è¦ï¼ï¼è¿™ä¸€è¡Œå°±æ˜¯ä½ æƒ³è¦æ³›è§£æçš„åŸŸåé…ç½®.
#address=/hello.me/127.0.0.1


```

ä¸Šé¢ resolv-file æ‰€æŒ‡å‘çš„æ–‡ä»¶æ˜¯è¦é…ç½®çš„ä¸Šæ¸¸ dns æœåŠ¡å™¨,/Users/xiongchuanhong/dnsmasq.conf é…ç½®å¦‚ä¸‹:

```
(base)Â âœÂ Â ~Â catÂ /Users/xiongchuanhong/dnsmasq.conf
Â nameserverÂ 8.8.8.8


```

å½“æœ¬åœ°è§£æä¸äº†åŸŸåï¼Œé‚£ä¹ˆ dnsmasq ä¼šè¯¢é—®å®ƒçš„ä¸Šæ¸¸ dns æœåŠ¡å™¨ï¼Œæ‰€ä»¥æˆ‘ä»¬æŠŠå®ƒé…ç½®æˆè°·æ­Œçš„åŸŸåè§£æç³»ç»Ÿã€‚

> â
> 
> ğŸ“¢ğŸ“¢æ³¨æ„ Users/xiongchuanhong/dnsmasq.conf å’Œ Users/xiongchuanhong/logs/dnsmasq.log æ–‡ä»¶éƒ½éœ€è¦ç”¨ root ç”¨æˆ·å»åˆ›å»ºï¼Œä¸ç„¶åˆ°æ—¶å€™è¿è¡Œä¼šæŠ¥æƒé™é”™è¯¯ã€‚
> 
> â

æ¥ç€å¯åŠ¨ dnsmasq æœåŠ¡

```
sudoÂ brewÂ servicesÂ startÂ Â dnsmasq


```

ç„¶åå†æŠŠæœºå™¨çš„ dns æœåŠ¡å™¨ ip æ”¹æˆ 127.0.0.1

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/81178hAUFMicze0mKCb4LY1jctCXDsBPIOSZG3ML9Sc59ZRVK2AnBkq82ngVicrPQVBQWK14GDUHXVOSzBRECHQw/640?wx_fmt=jpeg)1791686894116_.pic.jpg![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/81178hAUFMicze0mKCb4LY1jctCXDsBPIj13HADTmP6m8Fxe5VRGBVliaicmmP9e6wsmpzho2FcNicgL1KwsibQAqgg/640?wx_fmt=jpeg)1801686894126_.pic.jpg

æ¥ç€æµ‹è¯•ä¸‹ä¿®æ”¹åçš„ç½‘ç»œè®¿é—®æœ‰æ²¡æœ‰é—®é¢˜

```
(base)Â âœÂ Â ~Â pingÂ www.baidu.com
PINGÂ www.a.shifen.comÂ (14.119.104.189):Â 56Â dataÂ bytes
64Â bytesÂ fromÂ 14.119.104.189:Â icmp_seq=0Â ttl=54Â time=36.413Â ms
64Â bytesÂ fromÂ 14.119.104.189:Â icmp_seq=1Â ttl=54Â time=11.351Â ms
64Â bytesÂ fromÂ 14.119.104.189:Â icmp_seq=2Â ttl=54Â time=11.339Â ms
64Â bytesÂ fromÂ 14.119.104.189:Â icmp_seq=3Â ttl=54Â time=16.660Â ms


```

åŸŸåè§£ææ­£å¸¸ï¼Œæ¥ç€è¿›è¡Œä¸‹é¢çš„æ­¥éª¤ã€‚

### æ­å»ºå›æºæœåŠ¡å™¨å’Œ cdn è¾¹ç¼˜èŠ‚ç‚¹

æ¥ç€æˆ‘ä»¬æ¥å¿«é€Ÿæ­å»ºä¸‹å›æºæœåŠ¡å™¨å’Œ cdn çš„è¾¹ç¼˜èŠ‚ç‚¹ï¼Œè¿™é‡Œæˆ‘æ˜¯ç›´æ¥å€Ÿç”¨äº† nginx æ¥è¿›è¡Œæ­å»ºï¼Œå› ä¸º nginx å¯ä»¥ç”¨ä½œé™æ€èµ„æºæœåŠ¡å™¨ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥å¯åŠ¨ä¸€ä¸ª nginx å®¹å™¨æŠŠå®ƒä½œä¸ºæºæœåŠ¡å™¨ï¼Œæä¾›å›¾ç‰‡èµ„æºçš„è®¿é—®ã€‚ å¹¶ä¸” nginx ä¹Ÿèƒ½æä¾›ç¼“å­˜æœåŠ¡ï¼Œè¿™ä¹Ÿåˆšå¥½ç¬¦åˆè¾¹ç¼˜èŠ‚ç‚¹ç¼“å­˜èµ„æºçš„éœ€æ±‚ã€‚ç”±äºè¾¹ç¼˜èŠ‚ç‚¹éœ€è¦å›æºåˆ°æºæœåŠ¡å™¨ï¼Œä½†æ˜¯å®¹å™¨çš„ ip åˆæ˜¯ä¸å›ºå®šçš„ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ç›´æ¥ç”¨ docker-compose å¯¹è¿™ä¸¤ä¸ªå®¹å™¨è¿›è¡Œäº†ç¼–æ’ï¼Œè¿™æ ·åœ¨å†™ nginx é…ç½®æ–‡ä»¶çš„æ—¶å€™ï¼Œä¾¿å¯ä»¥ç”¨å®¹å™¨åä»£æ›¿ ip äº†ã€‚

#### docker-compose.yaml é…ç½®æ–‡ä»¶

```
version:Â "3"Â Â 
services:Â Â 
Â Â sourceserver:Â Â 
Â Â Â Â image:Â nginx:latestÂ Â 
Â Â Â Â container_name:Â source-serverÂ Â 
Â Â Â Â hostname:Â source-serverÂ Â 
Â Â Â Â ports:Â Â 
Â Â Â Â Â Â -Â '8080:80'Â Â 
Â Â Â Â volumes:Â Â 
Â Â Â Â Â Â -Â ./sourceserver/nginx.conf:/etc/nginx/nginx.confÂ Â 
Â Â Â Â Â Â -Â ./sourceserver/logs:/var/log/nginxÂ Â 
Â Â Â Â Â Â -Â ./sourceserver/imgs:/imgsÂ Â 
Â Â 
Â Â edgenode:Â Â 
Â Â Â Â image:Â nginx:latestÂ Â 
Â Â Â Â container_name:Â edgenodeÂ Â 
Â Â Â Â hostname:Â edgenodeÂ Â 
Â Â Â Â ports:Â Â 
Â Â Â Â Â Â -Â '80:80'Â Â 
Â Â Â Â volumes:Â Â 
Â Â Â Â Â Â -Â ./edgenode/nginx.conf:/etc/nginx/nginx.confÂ Â 
Â Â Â Â Â Â -Â ./edgenode/logs:/var/log/nginxÂ Â 
Â Â Â Â Â Â -Â ./edgenode/cache:/cache


```

#### æºç«™æœåŠ¡å™¨çš„ nginx é…ç½®

```
Â Â 
worker_processesÂ Â 1;Â Â 
error_logÂ Â Â /var/log/nginx/error.log;Â Â 
eventsÂ {Â Â 
Â Â Â Â worker_connectionsÂ Â 1024;Â Â 
}Â Â 
httpÂ {Â Â 
Â Â Â Â default_typeÂ Â application/octet-stream;Â Â 
Â Â Â Â log_formatÂ Â mainÂ Â '$remote_addrÂ -Â $remote_userÂ [$time_local]Â "$request"Â 'Â Â 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â '$statusÂ $body_bytes_sentÂ "$http_referer"Â 'Â Â 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â '"$http_user_agent"Â "$http_x_forwarded_for"';Â Â 
Â Â Â Â #Â é™æ€èµ„æºé…ç½®Â Â 
Â Â Â Â serverÂ {Â Â 
Â Â Â Â Â Â Â Â listenÂ Â Â Â Â Â Â 80;Â Â 
Â Â Â Â Â Â Â Â access_logÂ Â /var/log/nginx/access.logÂ Â mainÂ ;Â Â 
Â Â Â Â Â Â Â Â locationÂ /staticÂ {Â Â 
Â Â Â Â Â Â Â Â Â Â Â Â aliasÂ Â Â /imgs;Â Â 
Â Â Â Â Â Â Â Â }Â Â 
Â Â Â Â }Â Â 
}


```

#### è¾¹ç¼˜èŠ‚ç‚¹çš„ nginx é…ç½®

åœ¨ server æ¨¡å—é‡Œï¼Œæˆ‘ä»¬é…ç½® proxy_pass è½¬å‘è·¯å¾„æ—¶ï¼Œç›´æ¥ç”¨æºæœåŠ¡å™¨çš„å®¹å™¨åä»£æ›¿äº† ipï¼Œhttp://sourceserverã€‚å½“æœ¬åœ°æ²¡æœ‰ç¼“å­˜æ—¶ï¼Œå°±ä¼šé€šè¿‡ http://sourceserver è®¿é—®æºç«™æœåŠ¡å™¨ã€‚

> â
> 
> ğŸ“¢ğŸ“¢æ³¨æ„ä¸‹ï¼Œåœ¨çœŸå®ç¯å¢ƒé‡Œï¼Œè¾¹ç¼˜èŠ‚ç‚¹çš„æºç«™æœåŠ¡å™¨åå’ŒåŠ é€ŸåŸŸåè‚¯å®šä¸æ˜¯å†™æ­»çš„ï¼Œæ˜¯ç”¨æˆ·é…ç½®åœ¨ cdn æœåŠ¡å•†çš„æ•°æ®åº“é‡Œï¼Œç„¶åè¾¹ç¼˜èŠ‚ç‚¹å†ä»æœåŠ¡å™¨é‡Œè¯»å–çš„ã€‚
> 
> å¹¶ä¸”è¾¹ç¼˜èŠ‚ç‚¹è¦æ±‚åªæœ‰ç”¨æˆ·çš„åŠ é€ŸåŸŸåæ‰èƒ½è®¿é—®ï¼Œæ‰€ä»¥åœ¨è½¬å‘è¯·æ±‚å‰è¿˜è¦åˆ¤æ–­ä¸‹åŸŸåæ˜¯ä¸æ˜¯ç”¨æˆ·çš„åŠ é€ŸåŸŸåã€‚
> 
> â

```
worker_processesÂ Â 1;Â Â 
error_logÂ Â Â /var/log/nginx/error.log;Â Â 
eventsÂ {Â Â 
Â Â Â Â worker_connectionsÂ Â 1024;Â Â 
}Â Â 
httpÂ {Â Â 
Â Â Â Â log_formatÂ Â mainÂ Â '$host-Â $remote_addrÂ -Â $remote_userÂ [$time_local]Â "$request"Â 'Â Â 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â '$statusÂ $body_bytes_sentÂ "$http_referer"Â 'Â Â 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â '"$http_user_agent"Â "$http_x_forwarded_for"';Â Â 
Â Â Â Â Â Â proxy_cache_pathÂ Â /cacheÂ levels=1:2Â keys_zone=lanpangzi-cache:20mÂ max_size=50gÂ inactive=168h;Â Â 
Â Â Â Â Â Â proxy_cacheÂ lanpangzi-cache;Â Â 
Â Â Â Â Â Â proxy_cache_validÂ 168h;Â Â 
Â Â serverÂ {Â Â 
Â Â Â Â Â Â rootÂ /static;Â Â 
Â Â Â Â Â Â listenÂ Â Â Â Â Â Â 80;Â Â 
Â Â Â Â Â Â locationÂ ~*Â \.(css|js|png|jpg|jpeg|gif|gz|svg|mp4|ogg|ogv|webm|htc|xml|woff)$Â {Â Â 
Â Â Â Â Â Â Â Â ifÂ ($hostÂ !=Â 'web.cdn.test')Â Â {Â Â 
Â Â Â Â Â Â Â Â Â Â Â Â Â returnÂ 403;Â Â 
Â Â Â Â Â Â Â Â Â Â Â }Â Â 
Â Â Â Â Â Â access_logÂ Â /var/log/nginx/access.logÂ Â main;Â Â 
Â Â Â Â Â Â proxy_passÂ http://sourceserver;Â Â 
Â Â Â Â }Â Â 
Â Â }Â Â 
}


```

è¿™æ ·å°±å¿«é€Ÿæ­å»ºå¥½äº†æºæœåŠ¡å™¨å’Œè¾¹ç¼˜èŠ‚ç‚¹ï¼Œæˆ‘ä»¬åˆ°æ—¶å€™ç›´æ¥ç”¨ docker-compose up å‘½ä»¤ä¾¿å¯ä»¥å¯åŠ¨å®¹å™¨ï¼Œè¾¹ç¼˜èŠ‚ç‚¹ç›‘å¬äº†æœ¬åœ° 80 ç«¯å£ã€‚

### æ­å»º cdn çš„åŸŸåè°ƒåº¦ç³»ç»Ÿ

æœ€åï¼Œæˆ‘ä»¬æ¥æ­å»ºä¸‹ cdn çš„åŸŸåè°ƒåº¦ç³»ç»Ÿï¼Œé˜²æ­¢é—å¿˜ï¼Œæˆ‘ä»¬å†æ¥ä¸²è”ä¸‹é…ç½® cdn çš„è¿‡ç¨‹ï¼Œç”¨æˆ·æ‹¥æœ‰è‡ªå·±çš„åŠ é€ŸåŸŸåå’Œæºç«™æœåŠ¡å™¨ï¼Œå¹¶ä¸”å°†è¿™ä¸¤ä¸ªå‘Šè¯‰äº† cdn æœåŠ¡å•†ï¼Œcdn æœåŠ¡å•†å°±äº§ç”Ÿä¸€ä¸ªæ–°åŸŸåï¼Œè¿™ä¸ªæ–°åŸŸåéœ€è¦é…ç½®ä¸º cname è®°å½•ï¼Œä¸ç”¨æˆ·çš„åŠ é€ŸåŸŸåå…³è”èµ·æ¥ï¼Œè¿™æ¡ cname è®°å½•ä½œæˆ‘ä»¬åœ¨æ­å»º dnsmasq æ—¶å·²ç»å†™æ­»åœ¨äº†é…ç½®æ–‡ä»¶é‡Œã€‚

```
cname=web.cdn.test,web.cdn.test.c.lanpangzi


```

> â
> 
> ğŸ“¢ğŸ“¢æ³¨æ„ï¼Œç°å®ä¸­ï¼Œcdn æœåŠ¡å•†æ–°ç”Ÿæˆçš„åŸŸåéœ€è¦ç”¨æˆ·è‡ªå·±å»å…¶ dns æœåŠ¡å•†é‚£é‡Œå»è¿›è¡Œé…ç½®
> 
> â

åŒæ—¶ï¼Œcdn æœåŠ¡å•†ç”Ÿæˆçš„æ–°åŸŸåè§£æå› ä¸ºé…ç½®çš„**ã€Œnsã€**è®°å½•ï¼Œå·²ç»å°†æ–°çš„è¿™ä¸ªåŸŸåè§£ææŒ‡å‘äº†è‡ªå·±çš„ dns åŸŸåè°ƒåº¦ç³»ç»Ÿï¼Œåˆ°æ—¶å€™é€šè¿‡è¿™ä¸ªç³»ç»Ÿä¾¿å¯ä»¥è¿”å›ç»™ç”¨æˆ·æœ€è¿‘çš„è¾¹ç¼˜èŠ‚ç‚¹çš„ ipã€‚

è¿™æ¡ ns è®°å½•æˆ‘ä»¬ä¹Ÿå†™æ­»åœ¨äº† dnsmasq çš„é…ç½®æ–‡ä»¶é‡Œã€‚

```
server=/c.lanpangzi/127.0.0.1#1053


```

åˆ°æ—¶å€™æˆ‘ä»¬æœ¬åœ°ä¼šåœ¨ 1053 ç«¯å£å¯åŠ¨ä¸€ä¸ªè¿›ç¨‹ç”¨äºå¯¹ c.lanpangzi åŸŸåè¿›è¡Œè§£æã€‚

æ¥ç€æ¥æ€è€ƒğŸ¤”ä¸‹å¦‚ä½•å†™ä¸€ä¸ªåŸŸåè°ƒåº¦ç³»ç»Ÿï¼Œæˆ‘ä»¬çš„æœåŠ¡é€šä¿¡éœ€è¦éµå¾ª dns åè®®ï¼Œç”±äºæˆ‘ä»¬çš„è¾¹ç¼˜èŠ‚ç‚¹æ˜¯éƒ¨ç½²åˆ°æœ¬åœ°ï¼Œip æ˜¯ 127.0.0.1ï¼Œæ‰€ä»¥å½“è§£æåˆ°è¯·æ±‚æ—¶è¦è¯¢é—® web.cdn.test.c.lanpangzi è¿™ä¸ªåŸŸåæ—¶ï¼Œç›´æ¥è¿”å›æœ¬åœ°è¿™ä¸ª ip å³å¯ã€‚ é‚£å¯¹äºå…¶ä»–åŸŸåå¦‚ä½•å¤„ç†ï¼Œå½“ç„¶æ˜¯ç›´æ¥ä¸¢æ‰ï¼Œå› ä¸º cdn çš„åŸŸåè°ƒåº¦ç³»ç»Ÿï¼Œåªæä¾›å¯¹è‡ªå·± cdn æœåŠ¡å•†ç”Ÿæˆçš„åŸŸåè¿›è¡Œè§£æã€‚

ç”¨ golang ç®€å•å®ç°ä»£ç å¦‚ä¸‹:

è¿™é‡Œæˆ‘ç›´æ¥åœ¨ä»£ç é‡Œå°† cname åŸŸåä»¥åŠè¾¹ç¼˜èŠ‚ç‚¹çš„ ip å†™æ­»åœ¨ä»£ç é‡Œäº† (é‡åœ¨æ¨¡æ‹Ÿ cdn è¯·æ±‚è¿‡ç¨‹)ï¼Œåªè¦æ˜¯ web.cdn.test.c.lanpangzi. è¿™ä¸ªåŸŸåå°±è¿”å›è¾¹ç¼˜èŠ‚ç‚¹ ipï¼Œç”±äºæˆ‘ä»¬éƒ½æ˜¯éƒ¨ç½²åˆ°æœ¬åœ°ï¼Œæ‰€ä»¥è¾¹ç¼˜èŠ‚ç‚¹ ip å°±æ˜¯ 127.0.0.1 äº†ï¼Œdns çš„è§£æç”¨äº†ç°æˆçš„ golang åº“ã€‚

```
importÂ (Â Â 
Â Â Â "github.com/miekg/dns"Â Â 
Â Â Â "log"Â Â Â "net")Â Â 
Â Â 
varÂ cdnConfigÂ =Â map[string]string{Â Â 
Â Â Â "web.cdn.test.c.lanpangzi.":Â "127.0.0.1",Â Â 
}Â Â 
Â Â 
//Â å¤„ç†åˆ°æ¥çš„è¯·æ±‚Â Â 
funcÂ handler(writerÂ dns.ResponseWriter,Â reqÂ *dns.Msg)Â {Â Â 
Â Â Â varÂ respÂ dns.MsgÂ Â 
Â Â Â resp.SetReply(req)Â //Â åˆ›å»ºåº”ç­”Â Â 
Â Â Â forÂ _,Â questionÂ :=Â rangeÂ req.QuestionÂ {Â Â 
Â Â Â Â Â Â ipÂ :=Â cdnConfig[question.Name]Â Â 
Â Â Â Â Â Â ifÂ len(ip)Â ==Â 0Â {Â Â 
Â Â Â Â Â Â Â Â Â returnÂ Â 
Â Â Â Â Â Â }Â Â 
Â Â Â Â Â Â recordAÂ :=Â dns.A{Â Â 
Â Â Â Â Â Â Â Â Â Hdr:Â dns.RR_Header{Â Â 
Â Â Â Â Â Â Â Â Â Â Â Â Name:Â Â Â question.Name,Â Â 
Â Â Â Â Â Â Â Â Â Â Â Â Rrtype:Â dns.TypeA,Â Â 
Â Â Â Â Â Â Â Â Â Â Â Â Class:Â Â dns.ClassINET,Â Â 
Â Â Â Â Â Â Â Â Â Â Â Â Ttl:Â Â Â Â 100,Â Â 
Â Â Â Â Â Â Â Â Â },Â Â 
Â Â Â Â Â Â Â Â Â A:Â net.ParseIP(ip).To4(),Â //Â å…¨éƒ¨è§£æä¸º127.0.0.1Â Â 
Â Â Â Â Â Â }Â Â 
Â Â Â Â Â Â resp.AnswerÂ =Â append(resp.Answer,Â &recordA)Â //Â å†™å…¥åº”ç­”Â Â 
Â Â Â }Â Â 
Â Â Â errÂ :=Â writer.WriteMsg(&resp)Â //Â å›å†™ä¿¡æ¯Â Â 
Â Â Â ifÂ errÂ !=Â nilÂ {Â Â 
Â Â Â Â Â Â returnÂ Â 
Â Â Â }Â Â 
}Â Â 
Â Â 
funcÂ main()Â {Â Â 
Â Â Â dns.HandleFunc(".",Â handler)Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â //Â ç»‘å®šå‡½æ•°Â Â 
Â Â Â errÂ :=Â dns.ListenAndServe(":1053",Â "udp",Â nil)Â //Â å¯åŠ¨Â Â 
Â Â Â ifÂ errÂ !=Â nilÂ {Â Â 
Â Â Â Â Â Â log.Println(err)Â Â 
Â Â Â }Â Â 
}


```

### æµ‹è¯•

æ¥ç€ï¼Œæˆ‘ä»¬å°±å¯ä»¥æµ‹è¯•ä¸‹ç°åœ¨æ­å»ºçš„è¿™ä¸ª cdn ç³»ç»Ÿäº†ï¼Œè™½ç„¶æˆ‘ä»¬å°†å¾ˆå¤šé…ç½®ä¿¡æ¯éƒ½å†™æ­»åœ¨äº†ä»£ç é‡Œï¼Œä½†ä½ å¯ä»¥å‡è£…ä»–ä»¬æ˜¯è‡ªåŠ¨é…ç½®ä¸Šçš„ğŸ¶ã€‚

æ¥çœ‹ä¸‹ç°åœ¨çš„ä»£ç æ¡†æ¶.

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/81178hAUFMicze0mKCb4LY1jctCXDsBPIxYdRmU4BDgWtYw1FPHqYR81NsKeiaw8EBAlhiaSmk696CnsHhYWzvLnA/640?wx_fmt=jpeg)Pasted image 20230616164830.png

cnddns å°±æ˜¯æ¨¡æ‹Ÿçš„ cdn è°ƒåº¦ä¸­å¿ƒäº†ï¼Œedgenode å’Œ sourceserver æ”¾çš„éƒ½æ˜¯ nginx çš„é…ç½®æ–‡ä»¶ï¼Œdocker-compose.yaml åˆ°æ—¶å€™ä¼šå¯åŠ¨ä»–ä»¬ã€‚

#### å¯åŠ¨æºç«™æœåŠ¡å™¨ï¼Œè¾¹ç¼˜èŠ‚ç‚¹

```
(base)Â âœÂ Â cdndemoÂ git:(master)Â âœ—Â docker-composeÂ upÂ 
StartingÂ edgenodeÂ Â Â Â Â Â ...Â done
StartingÂ source-serverÂ ...Â done
AttachingÂ toÂ edgenode,Â source-server
source-serverÂ Â Â |Â /docker-entrypoint.sh:Â /docker-entrypoint.d/Â isÂ notÂ empty,Â willÂ attemptÂ toÂ performÂ configuration
source-serverÂ Â Â |Â /docker-entrypoint.sh:Â LookingÂ forÂ shellÂ scriptsÂ inÂ /docker-entrypoint.d/
source-serverÂ Â Â |Â /docker-entrypoint.sh:Â LaunchingÂ /docker-entrypoint.d/10-listen-on-ipv6-by-default.sh



```

#### å¯åŠ¨ cdn è°ƒåº¦ä¸­å¿ƒ

```
(base)Â âœÂ Â cdndemoÂ git:(master)Â âœ—Â cdÂ cdndnsÂ Â Â Â Â Â Â Â Â Â Â Â 
(base)Â âœÂ Â cdndnsÂ git:(master)Â âœ—Â goÂ runÂ main.goÂ Â 


```

#### æµ‹è¯•è®¿é—®

æˆ‘ä»¬å·²ç»æŠŠæœ¬åœ°æœºå™¨çš„ dns æœåŠ¡å™¨æ”¹ä¸º dnsmasq äº†ï¼Œæ¥ç€å°±æ˜¯æœ€åæµ‹è¯•ä¸‹è®¿é—®æ˜¯å¦ç”Ÿæ•ˆã€‚

æˆ‘åœ¨æµè§ˆå™¨è¿ç»­è¿›è¡Œäº†ä¸¤æ¬¡è®¿é—®

```
http://web.cdn.test/static/1781686486866_.pic.jpg


```

æ¥ç€æŸ¥çœ‹ä¸‹ nginx çš„ access.log

è¾¹ç¼˜èŠ‚ç‚¹çš„æ—¥å¿—

```
web.cdn.test-Â 172.22.0.1Â -Â -Â [16/Jun/2023:08:53:12Â +0000]Â "GETÂ /static/1781686486866_.pic.jpgÂ HTTP/1.1"Â 304Â 0Â "-"Â "Mozilla/5.0Â (Macintosh;Â IntelÂ MacÂ OSÂ XÂ 10_15_7)Â AppleWebKit/537.36Â (KHTML,Â likeÂ Gecko)Â Chrome/114.0.0.0Â Safari/537.36"Â "-"Â Â 
web.cdn.test-Â 172.22.0.1Â -Â -Â [16/Jun/2023:08:53:31Â +0000]Â "GETÂ /static/1781686486866_.pic.jpgÂ HTTP/1.1"Â 304Â 0Â "-"Â "Mozilla/5.0Â (Macintosh;Â IntelÂ MacÂ OSÂ XÂ 10_15_7)Â AppleWebKit/537.36Â (KHTML,Â likeÂ Gecko)Â Chrome/114.0.0.0Â Safari/537.36"Â "-"


```

æºç«™æœåŠ¡å™¨æ—¥å¿—

```
sourceserver-Â 172.22.0.3Â -Â -Â [16/Jun/2023:08:53:12Â +0000]Â "GETÂ /static/1781686486866_.pic.jpgÂ HTTP/1.0"Â 200Â 265084Â "-"Â "Mozilla/5.0Â (Macintosh;Â IntelÂ MacÂ OSÂ XÂ 10_15_7)Â AppleWebKit/537.36Â (KHTML,Â likeÂ Gecko)Â Chrome/114.0.0.0Â Safari/537.36"Â "-"


```

å¯ä»¥çœ‹è§å½“ç¬¬äºŒæ¬¡è®¿é—®çš„æ—¶å€™ï¼Œæºç«™æœåŠ¡å™¨ä¸Šæ²¡æœ‰æ—¥å¿—äº†ï¼Œè¾¹ç¼˜èŠ‚ç‚¹ä»ç„¶æœ‰è®¿é—®æ—¥å¿—ï¼Œè¯´æ˜ç¬¬äºŒæ¬¡è®¿é—®å·²ç»ç›´æ¥ä»è¾¹ç¼˜èŠ‚ç‚¹è¯»å–åˆ°äº†å›¾ç‰‡ä¿¡æ¯ã€‚

è¿˜æ˜¯å¼ºçƒˆå»ºè®®æŠŠæºç ä¸‹ä¸‹æ¥äº²è‡ªå®éªŒä¸€éï¼Œä½ ä¼šæ›´åŠ æ·±åˆ»ğŸ‘ğŸ»ã€‚