> æœ¬æ–‡ç”± [ç®€æ‚¦ SimpRead](http://ksria.com/simpread/) è½¬ç ï¼Œ åŸæ–‡åœ°å€ [mp.weixin.qq.com](https://mp.weixin.qq.com/s?__biz=MzAxODE2MjM1MA==&mid=2651555725&idx=1&sn=d966cc2daeaf0dafe0fc95a5169127cc&chksm=8025504cb752d95a58162d28bd62691d77e19588503c350a2f8189f1bf7812a2e1a7649bf3d7&scene=21#wechat_redirect)

> ä½œè€…ï¼šGauch
> 
> https://segmentfault.com/a/1190000017042906

ç™»å½•ï¼Œå‡ ä¹ä»€ä¹ˆé¡¹ç›®éƒ½ä¼šç”¨åˆ°ï¼Œå…¶é‡è¦æ€§ä¸è¨€è€Œå–»ï¼Œè€Œå°ç¨‹åºçš„ç™»å½•å´ä¸€ç›´æ˜¯ä¸ºäººå¤´ç–¼çš„ä¸€ä»¶äº‹ï¼Œè¿™é‡Œæˆ‘åˆ†äº«ä¸‹æˆ‘ä»¬åœ¨å°ç¨‹åºç™»å½•ä¸Šçš„æ¢ç´¢ã€‚

é€šå¸¸çš„ç™»å½•éƒ½æ˜¯é€šè¿‡ä¸€ä¸ªè¡¨å•ï¼Œè¿™å¾ˆæ­£å¸¸ï¼Œä½†å¦‚æœåœ¨å°ç¨‹åºé‡Œä½ ä¹Ÿè¿™ä¹ˆåšé‚£å°±æœ‰ç‚¹ä¸å¯æ€è®®äº†ï¼Œå¾®ä¿¡çš„ä¸€é”®ç™»å½•å¯¹ç”¨æˆ·ä½“éªŒæœ‰å¤šå¥½ä½ éš¾é“ä¸çŸ¥é“ï¼Ÿä¸ç”¨æ˜¯ä¸æ˜¯è„‘å­æœ‰å‘ï¼Ÿæœ€ä¸»è¦ä½ è¦åˆ©ç”¨å¾®ä¿¡çš„ç”Ÿæ€å¿…é¡»éœ€è¦ç”¨å¾®ä¿¡çš„ç™»å½•ï¼Œä»¥è·å–ç›¸å…³ä¿¡æ¯æ¥å’Œå¾®ä¿¡äº¤äº’ï¼ŒOKï¼Œæˆ‘ä»¬è¿›å…¥æ­£é¢˜ã€‚

#### è§¦å‘ç™»å½•æˆæƒå¼¹çª—

ç”¨æˆ·åœ¨å°ç¨‹åºã€å°æ¸¸æˆä¸­éœ€è¦ç‚¹å‡»ç»„ä»¶åï¼Œæ‰å¯ä»¥è§¦å‘ç™»å½•æˆæƒå¼¹çª—ã€æˆæƒè‡ªå·±çš„æ˜µç§°å¤´åƒç­‰æ•°æ®ã€‚

å‹æƒ…æç¤ºä¸€ä¸‹ï¼š `wx.login` å¹¶ä¸éœ€è¦ç‚¹å‡»ç»„ä»¶ï¼Œéœ€è¦çš„æ˜¯ `wx.getUserInfo`ï¼Œä½†é€šå¸¸æˆ‘ä»¬éƒ½ä¼šç”¨åˆ° `UnionID`ã€ `encryptedData`ã€ `iv` ç­‰ä¿¡æ¯å®Œæˆå®Œæ•´çš„ç™»å½•æµç¨‹ï¼Œæœ¬æ–‡ä¸»è¦èšç„¦çš„ä¹Ÿæ˜¯è¿™ç§åœºæ™¯ã€‚

æ‰€ä»¥ä¹‹å‰ç›´æ¥é€šè¿‡è°ƒç”¨ API çš„æ–¹å¼å°±è¡Œä¸é€šäº†ï¼Œé‚£ä¹ˆé—®é¢˜æ¥äº†â€”â€”è¿™ä¸ªç‚¹å‡»æŒ‰é’®è¦æ”¾åˆ°å“ªé‡Œï¼Ÿ

æ”¾åˆ°é¦–é¡µï¼Œä¸€è¿›å°ç¨‹åºå°±å¿…é¡»å…ˆç™»å½•ã€‚è¿™æ ·æ˜¾ç„¶å¾ˆç²—æš´ï¼Œè€Œä¸”é—®é¢˜å¹¶æ²¡æœ‰è§£å†³ï¼Œåè€Œä¼šæŠŠç”¨æˆ·ç›´æ¥æ‹’ä¹‹é—¨å¤–ï¼Œæ¯•ç«Ÿä½ ä¸æ˜¯ç”¨å°ç¨‹åºåšåå°ç³»ç»Ÿï¼Œä»€ä¹ˆåœºæ™¯éƒ½éœ€è¦æˆæƒï¼Œå…ˆæˆæƒä¹Ÿæ˜¯å¿…é¡»çš„ã€‚

åœ¨éœ€è¦æˆæƒçš„æ—¶å€™è·³åˆ°ç™»é™†é¡µé¢ã€‚è¿™æ ·å°±è§£å†³äº†ä¸Šé¢é‡åˆ°çš„ä¸éœ€è¦æˆæƒçš„æ—¶å€™ä¹Ÿè¢«å¼ºåˆ¶æˆæƒï¼Œå¯æ˜¯è¿™æ ·å¥½å—ï¼Ÿ

ä½“éªŒä¸Šä¸å¥½ï¼Œæ“ä½œè¢«æ‰“æ–­ï¼Œå°¤å…¶æ•´ä¸ªé¡µé¢éƒ½ä¸éœ€è¦æˆæƒåªæœ‰åœ¨ä¸€ä¸ªåœ°æ–¹éœ€è¦æˆæƒçš„ï¼Œä¾‹å¦‚ï¼šä½ æ­£åœ¨è¯»ä¸€ç¯‡æ–‡ç« ï¼Œè¯»ç½¢æ·±æœ‰æ„Ÿè§¦ï¼Œæƒ³è¯„è®ºä¸€ç•ªï¼Œæ´‹æ´‹æ´’æ´’å‡ åå­—å†™å®Œæ­£å‡†å¤‡ç‚¹å‡»å‘¢ï¼Œä»–å¦ˆçš„è·³è½¬äº†ï¼è·³è½¬äº†ï¼

åˆä¸€ä¸ªæ¼æ–—ï¼Œå¢åŠ ç”¨æˆ·æµå¤±ç‡ã€‚è¿˜ TM è¦ç™»å½•ï¼å¾ˆå¤šç”¨æˆ·å¿ƒé‡Œä¸€å®šè¿™ä¹ˆæƒ³ã€‚

é‚£å°±ç›´æ¥æ”¾åœ¨éœ€è¦ç™»å½•çš„é¡µé¢ä¸Šï¼ˆè¿™ä¸æ˜¯æ¼æ–—å—ï¼Ÿå¾ˆå¤šè¯»è€…ä¸€å®šè¿™ä¹ˆæƒ³ã€‚ä½†æƒ³æƒ³çœ‹ä¸Šé¢é‚£ä¸ªåœºæ™¯ï¼Œç‚¹è¯„è®ºæ—¶åªæ˜¯éœ€è¦ç‚¹å‡»ä¸‹å¼¹å‡ºçš„ç™»å½•æŒ‰é’®ï¼Œè€Œä¸”è¿˜å‡æ¨¡å‡æ ·çš„ä»¥å¾®ä¿¡çš„å£å»æé†’ä½ éœ€è¦ç™»å½•ï¼Œé‚£ä½ ä¼šä¸ä¼šç™»å½•ï¼Ÿæœ€èµ·ç ä½ å¾ˆæ„¿æ„ç™»å½•ï¼Œè€Œä¸”æ¥çš„å¾ˆçªç„¶ï¼Œæˆ‘æ§å‡ ä¸ä½è‡ªå·±çš„æ‰‹å°±ç‚¹äº†ï¼ç‚¹äº†ï¼ï¼‰ã€‚

å¯æ˜¯è¿™ç§æ–¹å¼æœ‰ä¸€ä¸ªé—®é¢˜ï¼šæ€ä¹ˆåœ¨éœ€è¦çš„é¡µé¢éƒ½èƒ½å¼¹å‡ºç™»å½•æŒ‰é’®ï¼Ÿ

#### å¼¹å‡ºç™»å½•æŒ‰é’®

åº”è¯¥å¾ˆå¤šäººéƒ½èƒ½æƒ³åˆ°ï¼šæŠ½ç¦»å‡ºç»„ä»¶ï¼Œé‚£æ€ä¹ˆä¿è¯åœ¨éœ€è¦çš„é¡µé¢éƒ½æœ‰è¿™ä¸ªç»„ä»¶å‘¢ï¼Ÿé”™æ€ä¸€åƒä¹Ÿä¸èƒ½æ”¾è¿‡ä¸€ä¸ªï¼æŠŠç™»å½•ç»„ä»¶é›†æˆåˆ°å…±ç”¨çš„çˆ¶ç»„ä»¶ï¼Œç„¶ååœ¨æ¯ä¸ªé¡µé¢éƒ½ä½¿ç”¨ã€‚æˆ‘ä¹Ÿå»ºè®®è¿™ä¹ˆåšï¼Œå› ä¸ºè¿™ä¸ªå…±ç”¨çš„çˆ¶ç»„ä»¶å…¶å®åˆå¾ˆå¤šç”¨å¤„ï¼Œä¾‹å¦‚ iPhoneX é€‚é…ç­‰ã€‚

ç­‰ç­‰ï¼Œä»€ä¹ˆéƒ½å‡†å¤‡å¥½äº†ï¼Œä»€ä¹ˆæ—¶å€™éœ€è¦ç™»å½•å‘¢ï¼ŸXXï¼Œè¿™ä¸ªè‚¯å®šæ˜¯ä½ è‡ªå·±æ§åˆ¶çš„å•¦ã€‚å—¯ï½å¥½å§ï¼Œæˆ‘ä»¬æ¥ç†ä¸€ç†ã€‚

#### æ ¡éªŒæ˜¯å¦éœ€è¦é‰´æƒ

è¯·æ±‚æ¥å£çš„æ—¶å€™ï¼Œå—¯ï½è¿™æ˜¯å¤§å®¶çš„å…±è¯†ã€‚BOSS æ¥äº†â€”â€”æ€ä¹ˆé‰´æƒï¼Ÿ

![](https://mmbiz.qpic.cn/mmbiz_jpg/aVp1YC8UV0fFV6zzbicxvC8D2qTN5Qz2htQdLet90ttYnXianicR9iaYWegu8KESgf1j0x7beBpicq9yKKeL4E5erTg/640?wx_fmt=jpeg)

å®˜æ–¹çš„è¿™å¼ å›¾å·²ç»åšäº†å¾ˆè¯¦å°½çš„è¯´æ˜ï¼Œè¿™é‡Œä¸åšèµ˜è¿°ã€‚

ä½†æ˜¯çœ‹åˆ° `session_key` äº†å—ï¼Ÿçœ‹åˆ°å®˜æ–¹åŒæ—¶è¯´çš„äº†å—ï¼Ÿ

![](https://mmbiz.qpic.cn/mmbiz_png/aVp1YC8UV0fFV6zzbicxvC8D2qTN5Qz2hjuuicesO4Jjn8wcM9XTrl2oaUkGfRZxiam67Oic4iaUzAj5fNV4ZMdrqCA/640?wx_fmt=png)

æ‰€ä»¥é—®é¢˜åˆæ¥äº†ï¼šæ€ä¹ˆä¿è¯ `session_key` çš„æœ‰æ•ˆæ€§ï¼Ÿ

#### session_key çš„æœ‰æ•ˆæ€§

è¯šå¦‚ä¸Šå›¾ï¼š

*   è¦ä¿è¯è°ƒç”¨æ¥å£æ—¶åç«¯Â `session_key`Â ä¸å¤±æ•ˆï¼Œåªèƒ½åœ¨æ¯æ¬¡è°ƒç”¨å‰å…ˆä½¿ç”¨Â `wx.checkSession`Â æ£€æŸ¥æ˜¯å¦æœ‰æ•ˆ
    
*   å®è·µä¸­ä¹Ÿå‘ç°Â `wx.checkSeesion`Â éå¸¸è€—æ—¶ï¼Œå¤§çº¦ 200msï¼Œæ‰€ä»¥ä¹Ÿä¸èƒ½æ¯æ¬¡æ¥å£è°ƒç”¨å‰éƒ½ä½¿ç”¨Â `wx.checkSession`Â æ£€æŸ¥æ˜¯å¦æœ‰æ•ˆ
    
*   åŒæ—¶è¦æ³¨æ„âš ï¸å‰ç«¯ä¸èƒ½éšä¾¿é‡æ–°æ‰§è¡ŒÂ `wx.login`ï¼Œå› ä¸ºå¯èƒ½å¯¼è‡´æ­£åœ¨è¿›è¡Œçš„å…¶å®ƒåç«¯ä»»åŠ¡Â `session_key`Â å¤±æ•ˆ
    

å¤©å•¦å™œï¼Œæ€ä¹ˆåŠï¼Ÿï¼é€šè¿‡å®è·µå’Œå¶ç„¶çš„å‘ç°â€”â€”å®˜æ–¹çš„ç¤ºä¾‹ä»£ç ï¼š

![](https://mmbiz.qpic.cn/mmbiz_png/aVp1YC8UV0fFV6zzbicxvC8D2qTN5Qz2hR6BkXXgA0cS8yyqDNp5zwo8e84xwylLuWnBbRoO4zOmXetEeHib65Mw/640?wx_fmt=png)

å¾—çŸ¥ï¼šåœ¨ä½¿ç”¨å°ç¨‹åºæœŸé—´ session_key æ˜¯ä¸ä¼šå¤±æ•ˆçš„ï¼Œsoï¼Œä½ æƒ³åˆ°äº†ä»€ä¹ˆï¼Ÿ

*   åœ¨æ¯ä¸ªè¯·æ±‚å‰å»æ ¡éªŒæœ‰æ•ˆæ€§
    
*   å°†æ ¡éªŒæœ‰æ•ˆæ€§çš„ç»“æœå­˜å‚¨èµ·æ¥
    
*   é€šè¿‡ async/await å’Œåˆšæ‰å­˜å‚¨èµ·æ¥çš„ç»“æœæ¥ä¿è¯ä¸è¿‡å¤šè°ƒç”¨Â `wx.checkSession`
    

å…ˆé—®ä¸ªé—®é¢˜ï¼šä½ å‡†å¤‡ç”¨ä»€ä¹ˆæ–¹å¼æ¥å­˜å‚¨æ ¡éªŒçš„ç»“æœï¼Ÿ

è®©æ€è€ƒå…ˆé£ä¸€ä¼šã€‚

storage å—ï¼Ÿå½“ç„¶å¯ä»¥ï¼Œä¸è¿‡ä¸å¤Ÿå®Œç¾ï¼Œä¸ºä»€ä¹ˆï¼Ÿå› ä¸º storage æ˜¯æ°¸ä¹…çš„å­˜å‚¨ï¼Œè€Œ `session_key` çš„æœ‰æ•ˆæœŸå´åªæ˜¯åœ¨ä½¿ç”¨å°ç¨‹åºæœŸé—´ï¼Œæ‰€ä»¥ä½ éœ€è¦åœ¨å°ç¨‹åºç»“æŸåæ‰‹åŠ¨é‡ç½®è¯¥çŠ¶æ€ä»¥é‡æ–°æ ¡éªŒå…¶æœ‰æ•ˆæ€§ï¼Œé‚£æ˜¯ä¸æ˜¯åœ¨ app çš„ onUnload é‡Œé‡ç½®å‘¢ï¼Ÿä¸æ˜¯ï¼å¼€å‘è¿‡å°ç¨‹åºçš„åº”è¯¥éƒ½çŸ¥é“ï¼Œé‚£å°±æ˜¯ç»“æŸä½¿ç”¨å°ç¨‹åºçš„æ–¹å¼å¤ªå¤šï¼Œä¸èƒ½ä¿è¯æ¯ç§æ–¹å¼éƒ½ä¼šè§¦å‘ onUnloadï¼Œä¾‹å¦‚ç”¨æˆ·ç›´æ¥é”€æ¯äº†å¾®ä¿¡è¿›ç¨‹ğŸ˜³ï¼ˆå…¶å®ä½ ä¹Ÿå¯ä»¥åœ¨ app çš„ onShow é‡Œæï¼‰é‚£ç”¨ä»€ä¹ˆå‘¢ï¼Ÿç›´æ¥ç”¨å†…å­˜å•Šï¼Œå€ŸåŠ©å†…å­˜çš„è‡ªåŠ¨ç®¡ç†æ¥æ™ºèƒ½ç®¡ç†ï¼Œæ‰€ä»¥æœ€ç»ˆä»£ç åº”è¯¥æ˜¯è¿™æ ·çš„ï¼š

```
// doRequest.js
let wxSessionValid = null // å¾®ä¿¡session_keyçš„æœ‰æ•ˆæ€§
// å¸¦é‰´æƒçš„è¯·æ±‚å°è£…
async function doRequestWithCheckAuth() {
 Â ...
 Â if (typeof wxSessionValid !== 'boolean') {
 Â  Â wxSessionValid = await checkWxSession() // æ£€æŸ¥å¾®ä¿¡sessionæ˜¯å¦æœ‰æ•ˆ
 Â }
 Â if (!wxSessionValid) {
 Â  Â await reLogin() // é‡æ–°ç™»å½•
 Â }
 Â wxSessionValid = true // é‡æ–°ç™»é™†åsession_keyä¸€å®šæœ‰æ•ˆ
 Â ...
}
```

è¿™æ ·æ˜¯ä¸æ˜¯çœ‹èµ·æ¥æ¯”è¾ƒå®Œç¾äº†ï¼Ÿå—¯ï½

ä¸çŸ¥é“æœ‰æ²¡æœ‰åŒå­¦ç€æ€¥é—®ä¸šåŠ¡ä¾§çš„ sessionï¼ˆè‡ªå®šä¹‰çš„ç™»å½•æ€ï¼‰æ€ä¹ˆæ²¡è®²ï¼Ÿå—¯ï¼Œé‚£ç°åœ¨è®²å§ã€‚

#### æ ¡éªŒè®¤è¯ä½“ç³»

æ€ä¹ˆæ ¡éªŒå®Œæ•´çš„è®¤è¯ä½“ç³»ï¼Ÿå…¶å®å¾ˆç®€å•ï¼Œéƒ½ä¸æƒ³æŠŠå®ƒä½œä¸ºä¸€éƒ¨åˆ†æ¥è®²ï¼Œä½†æ—¢ç„¶è®²äº†å°±å¿…ç„¶æœ‰æˆ‘æƒ³å¼ºè°ƒçš„ï¼šæ ¡éªŒå¾®ä¿¡ç«¯çš„ `session_key` ç•¥æœ‰éº»çƒ¦ï¼Œä½†ä¸åº”è¯¥æŠŠå®ƒæŠ›ç»™æœåŠ¡ç«¯ã€‚

*   æœåŠ¡ç«¯ä¸èƒ½ç›´æ¥æ ¡éªŒÂ `session_key`Â çš„æœ‰æ•ˆæ€§è€Œæ˜¯é€šè¿‡è°ƒç”¨æ¥å£å‘ç°é”™è¯¯äº†æ‰çŸ¥é“å¤±æ•ˆäº†ï¼Œè¿™æ˜¯è¢«åŠ¨çš„
    
*   æœåŠ¡ç«¯éœ€è¦åŒæ—¶ç»´æŠ¤ä¸¤ä¸ª session
    

è€Œæ”¾åœ¨å‰ç«¯æˆ‘ä»¬åªéœ€è¦æ ¡éªŒä¸¤ä¸ª session çš„æœ‰æ•ˆæ€§å³å¯ï¼Œä»»ä½•ä¸€ä¸ªå¤±æ•ˆå°±é‡æ–°ç™»å½•ï¼Œè¿™æ˜¯ç§¯æä¸»åŠ¨æœ‰æ•ˆçš„æ“ä½œï¼Œåº”è¯¥è¢«æå€¡ã€‚

#### è´¯é€š

OKï¼ŒåŸºæœ¬ä¸Šæ¢³ç†çš„å·®ä¸å¤šäº†ï¼Œå°±å·®å¼¹ç™»å½•æŒ‰é’®äº†ï¼Œè¿™ä¸ªç®€å•ï¼Œè°ƒç”¨åˆšæ‰å°è£…çš„ç»„ä»¶çš„æ–¹æ³•å°±è¡Œäº†å˜›ï¼Œbingoï¼Œå¯æ˜¯ï¼Œç‚¹å®Œå…è®¸åå‘¢ï¼Ÿæ€ä¹ˆç»§ç»­ç”¨æˆ·çš„æ“ä½œå‘¢ï¼Ÿæ€ä¹ˆèƒ½è®©ç”¨æˆ·çš„ä½“éªŒä¸è¢«æ‰“æ–­å‘¢ï¼Ÿå…ˆå›æ”¾ä¸‹åˆšæ‰ reLogin çš„ä»£ç ï¼š

```
async function reLogin() {
 Â // ç¡®ä¿æœ‰ç”¨æˆ·ä¿¡æ¯
 Â await new Promise(resolve => { // âš ï¸æ³¨æ„å¼€å¤´æœ‰awaitï¼ï¼ï¼
 Â  Â wx.getSetting({
 Â  Â  Â success: (res) => {
 Â  Â  Â  Â // å¦‚æœç”¨æˆ·æ²¡æœ‰æˆæƒæˆ–è€…æ²¡æœ‰å¿…è¦çš„ç”¨æˆ·ä¿¡æ¯
 Â  Â  Â  Â if (!res.authSetting['scope.userInfo'] || !_.isRealTrue(wx.getStorageSync('userInfoRes').userInfo)) {
 Â  Â  Â  Â  Â navToLogin(resolve) // å»æç¤ºç”¨æˆ·ç‚¹å‡»ç™»å½•æŒ‰é’®ï¼Œâš ï¸æ³¨æ„ï¼šå¹¶æŠŠå½“å‰çš„resolveå¸¦è¿‡å»
 Â  Â  Â  Â } else {
 Â  Â  Â  Â  Â resolve() // é™é»˜ç™»å½•
 Â  Â  Â  Â }
 Â  Â  Â }
 Â  Â })
 Â })
 Â return new Promise((resolve) => {
 Â  Â wx.login({
 Â  Â  Â success: res => {
 Â  Â  Â  Â login(res.code).then((jwt) => {
 Â  Â  Â  Â  Â resolve(jwt) // resolve jwt
 Â  Â  Â  Â }) // é€šè¿‡codeè¿›è¡Œç™»å½•
 Â  Â  Â },
 Â  Â  Â fail(err) {
 Â  Â  Â  Â wx.showToast({
 Â  Â  Â  Â  Â title: err.errMsg,
 Â  Â  Â  Â  Â icon: 'none',
 Â  Â  Â  Â  Â duration: 2000
 Â  Â  Â  Â })
 Â  Â  Â }
 Â  Â })
 Â })
}
function navToLogin(resolve) {
 Â /* eslint-disable no-undef */
 Â const pages = getCurrentPages()
 Â const page = pages[pages.length - 1] // å½“å‰page
 Â page.openLoginModal(resolve) // æ‰“å¼€ç™»å½•æŒ‰é’®å¼¹æ¡†ï¼Œå¹¶æŠŠå½“å‰çš„resolveå¸¦è¿‡å»
}
```

ä¸Šé¢çš„ä»£ç æ³¨é‡Šé‡Œæœ‰ä¸¤ä¸ªâš ï¸æ³¨æ„çœ‹åˆ°æ²¡ï¼Ÿæ˜¯çš„ï¼Œé€šè¿‡å›è°ƒçš„æ–¹å¼ğŸ˜‚å½“ç”¨æˆ·åŒæ„æˆæƒäº†å°±ç»§ç»­ä½™ä¸‹çš„é€»è¾‘ï¼Œå¦‚æœè¢«æ‹’ç»äº†ï¼Œåˆ™å®‰åˆ©ä»–ï¼Œå†æ‹’ç»å°±ç»ˆæ­¢æ“ä½œï¼Œä¸‹æ¬¡éœ€è¦æˆæƒä¹Ÿä¼šç»§ç»­å¼¹å‡ºæˆæƒã€‚

æœ‰ä¸æ˜ç™½æ¬¢è¿è¯„è®ºç•™è¨€æŒ‡å‡ºï¼Œæˆ‘å†åšè¯´æ˜ä¿®æ”¹ï¼Œè°¢è°¢ã€‚