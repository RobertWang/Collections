> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [zhuanlan.zhihu.com](https://zhuanlan.zhihu.com/p/351095535)

​缘起
---

很多时候会遇到需要在 Linux 机器之间传文件的需求。但是又会受限于端口限制、连接限制等原因，不能直接 scp 或 rsync。比如，服务器集群有个堡垒机的话，通常会限制真实服务器只能从堡垒机 ssh 链接上去。这时候就不能直接 scp 或 rsync；或者有一种情况是再某些目录层级很多的情况下，只需要传每个（可能是多级）子目录下的某个文件或目录，比如在 projects 目录下，只传每个目录里的 .gitignore 文件，难道要一个一个地传输吗？不需要地。

那么怎么办呢？作为一个有经验和聪明的 Linux 玩家（对，我觉得英文 Hacker 其实更精确的翻译应该是 “玩家” 而不是黑客）来说，这是事儿吗？咱们另辟蹊径。

内网么……（摸下巴）…… 很多时候并没有完全封尽所有端口的访问……

命令简介
----

tar 是 Unix 里经典命令，用于打包目录。

nc (`netcat`) 则是个可以监听或和任意 tcp/udp 端口建立连接的工具。

### tar

Unix 世界的 `tar` 命令源自于古老的磁带机，`Tape ARchive` 的缩写。用于把文件名、访问权限、文件内容等信息打包到一起的一个命令，可以操作的对象是目录和文件。磁带机是什么？简单的说，就是一串字符（甚至是字节，如果你愿意那么理解）流。它的参数有很多，但我们目前要用到的有如下几个：

1.  `a` 参数，archive，说明是带上所有包括权限在内的属性
2.  `r` 参数，针对目录，说明是整个目录打包。`r` 来自于 `recursive`，意译的话，是 “嵌套深入”

有时候会因为数据量过大，要带上一些压缩，但是我更愿意在这种时候选择单独启动压缩命令，用最大压缩的方式。比如

`gzip -9`

那么我们的命令会变成

`tar cf - 目录名 | gzip -c9`

gzip 的 -c 参数指明压缩来源和目标都是标准输入输出。

### nc （netcat)

`netcat` 的命令名为 `nc`。形如 Unix 下的 cat 命令，`netcat` 意味着 net + cat，“通过网络进行 cat”（个人理解如此），它有一些有用的参数。

*   `-l` 监听某个端口
*   `-u` 使用 UDP 协议
*   `-p` 指定端口

不同版本的 netcat 会略有不同，比如有些版本下 `nc -l -p 9999` 会报错，而 `nc -l 9999` 就工作正常，而在另一些版本下就可以 `nc -l -p 9999` 工作正常。暂且抛开这些版本的不同，不就这个问题展开操作系统和实现版本差异之间的讨论，哪一种不报错，咱们就用哪一种先。

实现
--

### 接收端

首先需要用 nc 监听一个网络端口，然后才可以接收嘛。那么咱们用

```
nc -l -p 9999
```

然后等收到了文件内容以后，要解压（对 tar 来说其实叫 untar），那么接收端就可以

```
nc -l -p 9999 | tar xf -
```

好了，接收端地工作到此结束。nc 会一直等待有 client 连上来，直到断开。

### 发送端

发送端当然是先要把想要传输的文件内容准备好，变成字节流（对，tar 的强项）

```
tar cf - 目录名
```

或者如上所述，某个目录下的所有子目录中的 .gitignore，我用 `find` 命令来保证没有遗漏

```
tar cf - $(find . -name .gitignore)
```

然后用本地的 nc 连接接收端的 nc

```
tar cf - $(find . -name .gitignore) | nc SERVER-IP 9999
```

然后就等待传输结束了。

进阶
--

如果这些掌握了，那么我们可以写一个文件传服务了，比如某个服务中，每个用户有一个目录。出于某种原因，比如磁盘空间或是否 VIP 等，想要在服务期间迁移用户数据，那么我们就可以做一个 “用 shell script 写成的网络服务” 了。

怎么写？敬请期待下一篇~~

关于 tar 和 nc 的其他参数及用法，我会陆续写来。

原文发自公众号：飘逸的单粒子