> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s?__biz=MzA5NDIzNzY1OQ==&mid=2735623229&idx=1&sn=bb81b8513e1af35530e97f77985a1ad2&chksm=b6ab4a8981dcc39f9b7cf052b1b246c02846c8bba1c4bb80f912156ee19242774b0634743436&mpshare=1&scene=1&srcid=1010lEa3cTdAV0kjoeSvp60h&sharer_sharetime=1665413583731&sharer_shareid=8a467675e94cd5b11b6640b7770d6cc6#rd)

作者 | 程序喵大人

这篇文章分享一个面试中经常被问到的知识点：堆内存和栈内存有什么区别？平时开发应该使用堆内存还是栈内存？

要回答这个问题，我们首先需要知道什么是堆内存，什么是栈内存，它们的分配和回收有什么特点？ 

**先介绍下栈内存。**

栈内存是为线程留出的临时空间，每个线程都有一个固定大小的栈空间，而且栈空间存储的数据只能由当前线程访问，所以它是线程安全的。

栈空间的分配和回收是由系统来做的，我们不需要手动控制。

当一个函数调用时，系统就会为该函数的调用分配栈空间，当函数返回后，系统就会自动回收这块空间，同理，下次其它函数调用和返回，系统还是会自动分配和回收空间。

那它是怎么分配和回收的呢？

可以看下面这两个动画。

![](https://mmbiz.qpic.cn/mmbiz_gif/JeibBY5FJRBELM0w5hgsoU8P9SP6u24BJB5AuqibzOACPFnu80hwMPkRKOhXbiadBsPPKIjgjsJmvN1wINPyg8nSQ/640?wx_fmt=gif)

![](https://mmbiz.qpic.cn/mmbiz_gif/JeibBY5FJRBELM0w5hgsoU8P9SP6u24BJzaA5tsWv9WBhBNYQE4nFOdyibd46MqfHJ83YbN0O6lSqjj75AaXElCw/640?wx_fmt=gif)

栈空间的大小是固定的，它有一个水位线标识栈空间的分配状态，水位线里面的表示已经分配，然后这个水位线会根据函数调用和返回的情况自动调整。

这里可以看到，栈空间的分配和回收非常简单，只需要调整水位线位置就可以了，没有任何多余操作。

**那堆内存呢？**

我们平时在 C 语言和 C++ 中使用 malloc 和 new 分配的内存就是堆内存，堆内存的一大特点就是大小不固定，可以动态扩容，空间由程序员动态分配，更加灵活。

然而，既然有优点也必然伴随着缺点。

第一个缺点就是它容易产生内存泄露，malloc 出来的没有 free，new 出来的如果没有 delete，都会产生内存泄露，真正项目内存泄露产生的情况肯定比这个复杂得多。

第二个缺点，容易产生内存碎片，在分配和回收时需要对很多内存碎片进行整理，效率较低，具体可以看下面这个动画。

![](https://mmbiz.qpic.cn/mmbiz_gif/JeibBY5FJRBELM0w5hgsoU8P9SP6u24BJT6DP0SulYN8WBGFnxgjrBYVgTbd8K1gtMe1wNfBxp8cG02fheaVmkA/640?wx_fmt=gif)

所以才会有很多自定义的内存分配器，但它肯定还是没有栈空间分配回收速度快。

第三个缺点，线程不安全，它不像栈内存是线程独立的，堆内存可以被一个进程内所有的线程访问，多线程操作就容易产生问题，很多奇奇怪怪的操作就是这么引起的。

**那什么变量存储在栈上，什么存储在堆上呢？**

普通的 A a，这种就是都存储在栈上，当使用 new 和 malloc 分配的空间会存储在堆上，看下面这个图。

![](https://mmbiz.qpic.cn/mmbiz_jpg/JeibBY5FJRBELM0w5hgsoU8P9SP6u24BJYpu2MiaG7snia03omuDyqTGtrTB6oFvxHYNEIIuVGJkH26LNKQ3BRNmw/640?wx_fmt=jpeg)

new 出来的实际空间是在堆上分配，然后在栈上开辟一个指针大小的空间，这个空间有一个指针，指向堆上的那块内存，这样给变量和堆内存之间就关联起来了。

**那什么情况下使用栈内存，什么情况下使用堆内存呢？**

我整理出来了一个表，具体如下：

<table width="684"><colgroup><col><col><col></colgroup><tbody><tr><td><br></td><td><strong>栈</strong></td><td><strong>堆</strong></td></tr><tr><td>速度</td><td>快</td><td>慢</td></tr><tr><td>空间管理</td><td>高效，不会产生碎片</td><td>会产生内存碎片</td></tr><tr><td>访问权限</td><td>只能局部变量</td><td>可以访问全局变量</td></tr><tr><td>空间大小限制</td><td>操作系统限制</td><td>没有特定的限制</td></tr><tr><td>内存分配</td><td>连续</td><td>随机分配</td></tr><tr><td>分配和释放</td><td>编译器指令自动管理</td><td>程序员手动管理</td></tr><tr><td>开销</td><td>低</td><td>高</td></tr><tr><td>主要问题</td><td class="">空间小</td><td>内存碎片</td></tr><tr><td>灵活性</td><td class="">固定大小</td><td>可以 resize</td></tr></tbody></table>

这里可以根据实际需求来决定使用哪类内存。

当然，其实也不用关注那么多，一般就是大内存使用堆，局部变量小内存使用栈。

**参考链接：**

*   https://stackoverflow.com/questions/79923/what-and-where-are-the-stack-and-heap
    
*   https://www.guru99.com/stack-vs-heap.html
    
*   https://www.geeksforgeeks.org/stack-vs-heap-memory-allocation/